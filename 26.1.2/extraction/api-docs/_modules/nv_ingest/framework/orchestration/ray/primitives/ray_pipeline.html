

<!DOCTYPE html>


<html lang="en" data-content_root="../../../../../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>nv_ingest.framework.orchestration.ray.primitives.ray_pipeline &#8212; nv-ingest</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../../../../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../../../../../../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../../../../../../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../../../../../../_static/styles/nvidia-sphinx-theme.css?v=933278ad" />
    <link rel="stylesheet" type="text/css" href="../../../../../../_static/autodoc_pydantic.css?v=a0a71c94" />
  
  <!-- So that users can add custom icons -->
  <script src="../../../../../../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../../../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../../../../../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />



    <script src="../../../../../../_static/documentation_options.js?v=be04dab6"></script>
    <script src="../../../../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/nv_ingest/framework/orchestration/ray/primitives/ray_pipeline';</script>

    <link rel="icon" href="../../../../../../_static/favicon.png"/>

    <link rel="index" title="Index" href="../../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../../search.html" />


  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="" />


  </head>

  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>


  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../../../../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../../../../../../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../../../../../_static/nvidia-logo-horiz-rgb-blk-for-screen.svg" class="logo__image only-light" alt="nv-ingest - Home"/>
    <img src="../../../../../../_static/nvidia-logo-horiz-rgb-wht-for-screen.svg" class="logo__image only-dark pst-js-only" alt="nv-ingest - Home"/>
  
  
    <p class="title logo__title">nv-ingest</p>
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        



  
    
  

<a class="navbar-brand logo" href="../../../../../../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../../../../../_static/nvidia-logo-horiz-rgb-blk-for-screen.svg" class="logo__image only-light" alt="nv-ingest - Home"/>
    <img src="../../../../../../_static/nvidia-logo-horiz-rgb-wht-for-screen.svg" class="logo__image only-dark pst-js-only" alt="nv-ingest - Home"/>
  
  
    <p class="title logo__title">nv-ingest</p>
  
</a>


  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">



<nav class="bd-docs-nav bd-links"
     aria-label="Table of Contents">
  <p class="bd-links__title" role="heading" aria-level="1">Table of Contents</p>
  <div class="bd-toc-item navbar-nav"><p aria-level="2" class="caption" role="heading"><span class="caption-text">NV-Ingest Packages</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../../../../nv-ingest-api/modules.html">nv_ingest_api</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../../../../nv-ingest-api/nv_ingest_api.html">nv_ingest_api package</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../../../nv-ingest-api/nv_ingest_api.interface.html">nv_ingest_api.interface package</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../../../../../nv-ingest-api/nv_ingest_api.internal.html">nv_ingest_api.internal package</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../../../nv-ingest-api/nv_ingest_api.internal.enums.html">nv_ingest_api.internal.enums package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../../../nv-ingest-api/nv_ingest_api.internal.extract.html">nv_ingest_api.internal.extract package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../../../nv-ingest-api/nv_ingest_api.internal.meta.html">nv_ingest_api.internal.meta package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../../../nv-ingest-api/nv_ingest_api.internal.mutate.html">nv_ingest_api.internal.mutate package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../../../nv-ingest-api/nv_ingest_api.internal.primitives.html">nv_ingest_api.internal.primitives package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../../../nv-ingest-api/nv_ingest_api.internal.schemas.html">nv_ingest_api.internal.schemas package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../../../nv-ingest-api/nv_ingest_api.internal.store.html">nv_ingest_api.internal.store package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../../../nv-ingest-api/nv_ingest_api.internal.transform.html">nv_ingest_api.internal.transform package</a></li>
</ul>
</details></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../../../../../nv-ingest-api/nv_ingest_api.util.html">nv_ingest_api.util package</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../../../nv-ingest-api/nv_ingest_api.util.control_message.html">nv_ingest_api.util.control_message package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../../../nv-ingest-api/nv_ingest_api.util.converters.html">nv_ingest_api.util.converters package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../../../nv-ingest-api/nv_ingest_api.util.dataloader.html">nv_ingest_api.util.dataloader package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../../../nv-ingest-api/nv_ingest_api.util.detectors.html">nv_ingest_api.util.detectors package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../../../nv-ingest-api/nv_ingest_api.util.exception_handlers.html">nv_ingest_api.util.exception_handlers package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../../../nv-ingest-api/nv_ingest_api.util.image_processing.html">nv_ingest_api.util.image_processing package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../../../nv-ingest-api/nv_ingest_api.util.imports.html">nv_ingest_api.util.imports package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../../../nv-ingest-api/nv_ingest_api.util.introspection.html">nv_ingest_api.util.introspection package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../../../nv-ingest-api/nv_ingest_api.util.logging.html">nv_ingest_api.util.logging package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../../../nv-ingest-api/nv_ingest_api.util.message_brokers.html">nv_ingest_api.util.message_brokers package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../../../nv-ingest-api/nv_ingest_api.util.metadata.html">nv_ingest_api.util.metadata package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../../../nv-ingest-api/nv_ingest_api.util.multi_processing.html">nv_ingest_api.util.multi_processing package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../../../nv-ingest-api/nv_ingest_api.util.nim.html">nv_ingest_api.util.nim package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../../../nv-ingest-api/nv_ingest_api.util.pdf.html">nv_ingest_api.util.pdf package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../../../nv-ingest-api/nv_ingest_api.util.schema.html">nv_ingest_api.util.schema package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../../../nv-ingest-api/nv_ingest_api.util.service_clients.html">nv_ingest_api.util.service_clients package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../../../nv-ingest-api/nv_ingest_api.util.string_processing.html">nv_ingest_api.util.string_processing package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../../../nv-ingest-api/nv_ingest_api.util.system.html">nv_ingest_api.util.system package</a></li>
</ul>
</details></li>
</ul>
</details></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../../../../nv-ingest-client/modules.html">nv_ingest_client</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../../../../nv-ingest-client/nv_ingest_client.html">nv_ingest_client package</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../../../../../nv-ingest-client/nv_ingest_client.cli.html">nv_ingest_client.cli package</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../../../nv-ingest-client/nv_ingest_client.cli.util.html">nv_ingest_client.cli.util package</a></li>
</ul>
</details></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../../../nv-ingest-client/nv_ingest_client.client.html">nv_ingest_client.client package</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../../../../../nv-ingest-client/nv_ingest_client.primitives.html">nv_ingest_client.primitives package</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../../../nv-ingest-client/nv_ingest_client.primitives.jobs.html">nv_ingest_client.primitives.jobs package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../../../nv-ingest-client/nv_ingest_client.primitives.tasks.html">nv_ingest_client.primitives.tasks package</a></li>
</ul>
</details></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../../../../../nv-ingest-client/nv_ingest_client.util.html">nv_ingest_client.util package</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../../../nv-ingest-client/nv_ingest_client.util.file_processing.html">nv_ingest_client.util.file_processing package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../../../nv-ingest-client/nv_ingest_client.util.vdb.html">nv_ingest_client.util.vdb package</a></li>
</ul>
</details></li>
</ul>
</details></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../../../../nv-ingest/modules.html">nv_ingest</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../../../../nv-ingest/nv_ingest.html">nv_ingest package</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../../../../../nv-ingest/nv_ingest.api.html">nv_ingest.api package</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../../../nv-ingest/nv_ingest.api.v1.html">nv_ingest.api.v1 package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../../../nv-ingest/nv_ingest.api.v2.html">nv_ingest.api.v2 package</a></li>
</ul>
</details></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../../../../../nv-ingest/nv_ingest.framework.html">nv_ingest.framework package</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../../../nv-ingest/nv_ingest.framework.orchestration.html">nv_ingest.framework.orchestration package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../../../nv-ingest/nv_ingest.framework.schemas.html">nv_ingest.framework.schemas package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../../../nv-ingest/nv_ingest.framework.util.html">nv_ingest.framework.util package</a></li>
</ul>
</details></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../../../../../nv-ingest/nv_ingest.pipeline.html">nv_ingest.pipeline package</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../../../nv-ingest/nv_ingest.pipeline.config.html">nv_ingest.pipeline.config package</a></li>
</ul>
</details></li>
</ul>
</details></li>
</ul>
</details></li>
</ul>
</div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>



      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../../../../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../../../../../index.html" class="nav-link">Module code</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">nv_ingest.framework.orchestration.ray.primitives.ray_pipeline</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <h1>Source code for nv_ingest.framework.orchestration.ray.primitives.ray_pipeline</h1><div class="highlight"><pre>
<span></span><span class="c1"># SPDX-FileCopyrightText: Copyright (c) 2024-25, NVIDIA CORPORATION &amp; AFFILIATES.</span>
<span class="c1"># All rights reserved.</span>
<span class="c1"># SPDX-License-Identifier: Apache-2.0</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">multiprocessing</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">threading</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">types</span><span class="w"> </span><span class="kn">import</span> <span class="n">FunctionType</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">psutil</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">uuid</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">ray</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ray.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">GetTimeoutError</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ray.util.queue</span><span class="w"> </span><span class="kn">import</span> <span class="n">Queue</span> <span class="k">as</span> <span class="n">RayQueue</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Any</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">concurrent.futures</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">nv_ingest.framework.orchestration.ray.primitives.pipeline_topology</span><span class="w"> </span><span class="kn">import</span> <span class="n">PipelineTopology</span><span class="p">,</span> <span class="n">StageInfo</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">nv_ingest.framework.orchestration.process.termination</span><span class="w"> </span><span class="kn">import</span> <span class="n">kill_pipeline_process_group</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">nv_ingest.framework.orchestration.ray.primitives.ray_stat_collector</span><span class="w"> </span><span class="kn">import</span> <span class="n">RayStatsCollector</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">nv_ingest.framework.orchestration.ray.util.pipeline.pid_controller</span><span class="w"> </span><span class="kn">import</span> <span class="n">PIDController</span><span class="p">,</span> <span class="n">ResourceConstraintManager</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">nv_ingest.framework.orchestration.ray.util.pipeline.tools</span><span class="w"> </span><span class="kn">import</span> <span class="n">wrap_callable_as_stage</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">nv_ingest_api.util.imports.callable_signatures</span><span class="w"> </span><span class="kn">import</span> <span class="n">ingest_stage_callable_signature</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">nv_ingest_api.util.imports.dynamic_resolvers</span><span class="w"> </span><span class="kn">import</span> <span class="n">resolve_callable_from_path</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="PipelineInterface">
<a class="viewcode-back" href="../../../../../../nv-ingest/nv_ingest.framework.orchestration.ray.primitives.html#nv_ingest.framework.orchestration.ray.primitives.ray_pipeline.PipelineInterface">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">PipelineInterface</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Abstract base class for pipeline implementations.</span>

<span class="sd">    Any concrete pipeline must implement start and stop methods.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="PipelineInterface.start">
<a class="viewcode-back" href="../../../../../../nv-ingest/nv_ingest.framework.orchestration.ray.primitives.html#nv_ingest.framework.orchestration.ray.primitives.ray_pipeline.PipelineInterface.start">[docs]</a>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">monitor_poll_interval</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span> <span class="n">scaling_poll_interval</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">30.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Start the pipeline.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        monitor_poll_interval : float</span>
<span class="sd">            Interval in seconds for the monitoring poll (default: 5.0).</span>
<span class="sd">        scaling_poll_interval : float</span>
<span class="sd">            Interval in seconds for scaling decisions (default: 30.0).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>


<div class="viewcode-block" id="PipelineInterface.stop">
<a class="viewcode-back" href="../../../../../../nv-ingest/nv_ingest.framework.orchestration.ray.primitives.html#nv_ingest.framework.orchestration.ray.primitives.ray_pipeline.PipelineInterface.stop">[docs]</a>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stop the pipeline and perform any necessary cleanup.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>
</div>



<span class="c1"># --- Configuration Objects ---</span>


<div class="viewcode-block" id="ScalingConfig">
<a class="viewcode-back" href="../../../../../../nv-ingest/nv_ingest.framework.orchestration.ray.primitives.html#nv_ingest.framework.orchestration.ray.primitives.ray_pipeline.ScalingConfig">[docs]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ScalingConfig</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Configuration for PID and Resource Constraint Manager based scaling.&quot;&quot;&quot;</span>

    <span class="n">dynamic_memory_scaling</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">dynamic_memory_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.75</span>
    <span class="n">pid_kp</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span>
    <span class="n">pid_ki</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span>
    <span class="n">pid_kd</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">pid_ema_alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span>
    <span class="n">pid_target_queue_depth</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">pid_penalty_factor</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span>
    <span class="n">pid_error_boost_factor</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.5</span>
    <span class="n">rcm_memory_safety_buffer_fraction</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.15</span></div>



<div class="viewcode-block" id="FlushingConfig">
<a class="viewcode-back" href="../../../../../../nv-ingest/nv_ingest.framework.orchestration.ray.primitives.html#nv_ingest.framework.orchestration.ray.primitives.ray_pipeline.FlushingConfig">[docs]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">FlushingConfig</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Configuration for queue flushing behavior.&quot;&quot;&quot;</span>

    <span class="n">queue_flush_interval_seconds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">600</span>
    <span class="n">queue_flush_drain_timeout_seconds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">300</span>
    <span class="n">quiet_period_threshold</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">consecutive_quiet_cycles_for_flush</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span></div>



<div class="viewcode-block" id="StatsConfig">
<a class="viewcode-back" href="../../../../../../nv-ingest/nv_ingest.framework.orchestration.ray.primitives.html#nv_ingest.framework.orchestration.ray.primitives.ray_pipeline.StatsConfig">[docs]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">StatsConfig</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Configuration for the RayStatsCollector.&quot;&quot;&quot;</span>

    <span class="n">collection_interval_seconds</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">10.0</span>
    <span class="n">actor_timeout_seconds</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span>
    <span class="n">queue_timeout_seconds</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span></div>



<div class="viewcode-block" id="RayPipelineSubprocessInterface">
<a class="viewcode-back" href="../../../../../../nv-ingest/nv_ingest.framework.orchestration.ray.primitives.html#nv_ingest.framework.orchestration.ray.primitives.ray_pipeline.RayPipelineSubprocessInterface">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">RayPipelineSubprocessInterface</span><span class="p">(</span><span class="n">PipelineInterface</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Pipeline interface implementation for a subprocess-based Ray pipeline.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">process</span><span class="p">:</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        process : multiprocessing.Process</span>
<span class="sd">            A handle to the running subprocess.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_process</span><span class="p">:</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span> <span class="o">=</span> <span class="n">process</span>

<div class="viewcode-block" id="RayPipelineSubprocessInterface.start">
<a class="viewcode-back" href="../../../../../../nv-ingest/nv_ingest.framework.orchestration.ray.primitives.html#nv_ingest.framework.orchestration.ray.primitives.ray_pipeline.RayPipelineSubprocessInterface.start">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">monitor_poll_interval</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span> <span class="n">scaling_poll_interval</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">30.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Start is not supported because the subprocess is assumed to already be running.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>


<div class="viewcode-block" id="RayPipelineSubprocessInterface.stop">
<a class="viewcode-back" href="../../../../../../nv-ingest/nv_ingest.framework.orchestration.ray.primitives.html#nv_ingest.framework.orchestration.ray.primitives.ray_pipeline.RayPipelineSubprocessInterface.stop">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stops the subprocess pipeline and its entire process group to ensure</span>
<span class="sd">        any child processes (e.g., the simple message broker) are terminated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">pid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_process</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Always attempt to terminate the entire process group</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">kill_pipeline_process_group</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;kill_pipeline_process_group failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="RayPipelineInterface">
<a class="viewcode-back" href="../../../../../../nv-ingest/nv_ingest.framework.orchestration.ray.primitives.html#nv_ingest.framework.orchestration.ray.primitives.ray_pipeline.RayPipelineInterface">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">RayPipelineInterface</span><span class="p">(</span><span class="n">PipelineInterface</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Pipeline interface for an in-process RayPipeline instance.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pipeline</span><span class="p">:</span> <span class="s2">&quot;RayPipeline&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pipeline : RayPipeline</span>
<span class="sd">            The instantiated pipeline to control.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pipeline</span> <span class="o">=</span> <span class="n">pipeline</span>

<div class="viewcode-block" id="RayPipelineInterface.start">
<a class="viewcode-back" href="../../../../../../nv-ingest/nv_ingest.framework.orchestration.ray.primitives.html#nv_ingest.framework.orchestration.ray.primitives.ray_pipeline.RayPipelineInterface.start">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">monitor_poll_interval</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span> <span class="n">scaling_poll_interval</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">30.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Starts the RayPipeline.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        monitor_poll_interval : float</span>
<span class="sd">            Unused here; provided for interface compatibility.</span>
<span class="sd">        scaling_poll_interval : float</span>
<span class="sd">            Unused here; provided for interface compatibility.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pipeline</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">monitor_poll_interval</span><span class="p">,</span> <span class="n">scaling_poll_interval</span><span class="p">)</span></div>


<div class="viewcode-block" id="RayPipelineInterface.stop">
<a class="viewcode-back" href="../../../../../../nv-ingest/nv_ingest.framework.orchestration.ray.primitives.html#nv_ingest.framework.orchestration.ray.primitives.ray_pipeline.RayPipelineInterface.stop">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stops the RayPipeline and shuts down Ray.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pipeline</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">ray</span>

            <span class="n">ray</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span></div>
</div>



<div class="viewcode-block" id="RayPipeline">
<a class="viewcode-back" href="../../../../../../nv-ingest/nv_ingest.framework.orchestration.ray.primitives.html#nv_ingest.framework.orchestration.ray.primitives.ray_pipeline.RayPipeline">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">RayPipeline</span><span class="p">(</span><span class="n">PipelineInterface</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A structured pipeline supporting dynamic scaling and queue flushing.</span>
<span class="sd">    Uses PIDController and ResourceConstraintManager. Supports optional GUI display.</span>
<span class="sd">    Delegates statistics collection to RayStatsCollector.</span>

<span class="sd">    Configuration is managed via dedicated config objects (ScalingConfig, etc.).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">scaling_config</span><span class="p">:</span> <span class="n">ScalingConfig</span> <span class="o">=</span> <span class="n">ScalingConfig</span><span class="p">(),</span>
        <span class="n">flushing_config</span><span class="p">:</span> <span class="n">FlushingConfig</span> <span class="o">=</span> <span class="n">FlushingConfig</span><span class="p">(),</span>
        <span class="n">stats_config</span><span class="p">:</span> <span class="n">StatsConfig</span> <span class="o">=</span> <span class="n">StatsConfig</span><span class="p">(),</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes the RayPipeline.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        scaling_config : ScalingConfig, optional</span>
<span class="sd">            Configuration for PID and resource constraint-based scaling, by default ScalingConfig().</span>
<span class="sd">        flushing_config : FlushingConfig, optional</span>
<span class="sd">            Configuration for queue flushing behavior, by default FlushingConfig().</span>
<span class="sd">        stats_config : StatsConfig, optional</span>
<span class="sd">            Configuration for the RayStatsCollector, by default StatsConfig().</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Store config objects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scaling_config</span> <span class="o">=</span> <span class="n">scaling_config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flushing_config</span> <span class="o">=</span> <span class="n">flushing_config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats_config</span> <span class="o">=</span> <span class="n">stats_config</span>

        <span class="c1"># --- Instantiate Topology ---</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">topology</span> <span class="o">=</span> <span class="n">PipelineTopology</span><span class="p">()</span>

        <span class="c1"># --- Structure Lock ---</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_structure_lock</span><span class="p">:</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>

        <span class="c1"># --- State ---</span>
        <span class="c1"># self.scaling_state: Dict[str, str] = {}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_global_memory_usage</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state_lock</span><span class="p">:</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stopping</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># --- Build Time Config &amp; State ---</span>
        <span class="c1"># Use scaling_config for these</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamic_memory_scaling</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaling_config</span><span class="o">.</span><span class="n">dynamic_memory_scaling</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamic_memory_threshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaling_config</span><span class="o">.</span><span class="n">dynamic_memory_threshold</span>

        <span class="c1"># --- Background Threads ---</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scaling_thread</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scaling_monitoring</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># --- Queue Flushing ---</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_queue_flush_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queue_flush_interval_seconds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flushing_config</span><span class="o">.</span><span class="n">queue_flush_interval_seconds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queue_flush_drain_timeout_seconds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flushing_config</span><span class="o">.</span><span class="n">queue_flush_drain_timeout_seconds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quiet_period_threshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flushing_config</span><span class="o">.</span><span class="n">quiet_period_threshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">consecutive_quiet_cycles_for_flush</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flushing_config</span><span class="o">.</span><span class="n">consecutive_quiet_cycles_for_flush</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_consecutive_quiet_cycles</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># --- Instantiate Autoscaling Controllers ---</span>
        <span class="c1"># Use scaling_config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pid_controller</span> <span class="o">=</span> <span class="n">PIDController</span><span class="p">(</span>
            <span class="n">kp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scaling_config</span><span class="o">.</span><span class="n">pid_kp</span><span class="p">,</span>
            <span class="n">ki</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scaling_config</span><span class="o">.</span><span class="n">pid_ki</span><span class="p">,</span>
            <span class="n">kd</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scaling_config</span><span class="o">.</span><span class="n">pid_kd</span><span class="p">,</span>
            <span class="n">target_queue_depth</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scaling_config</span><span class="o">.</span><span class="n">pid_target_queue_depth</span><span class="p">,</span>
            <span class="n">penalty_factor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scaling_config</span><span class="o">.</span><span class="n">pid_penalty_factor</span><span class="p">,</span>
            <span class="n">error_boost_factor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scaling_config</span><span class="o">.</span><span class="n">pid_error_boost_factor</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;PIDController initialized using ScalingConfig.&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">total_system_memory_bytes</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">virtual_memory</span><span class="p">()</span><span class="o">.</span><span class="n">total</span>
            <span class="c1"># Use scaling_config for dynamic_memory_threshold</span>
            <span class="n">absolute_memory_threshold_mb</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scaling_config</span><span class="o">.</span><span class="n">dynamic_memory_threshold</span> <span class="o">*</span> <span class="n">total_system_memory_bytes</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to get system memory: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. Using high limit.&quot;</span><span class="p">)</span>
            <span class="n">absolute_memory_threshold_mb</span> <span class="o">=</span> <span class="mi">1_000_000</span>  <span class="c1"># Fallback value</span>

        <span class="c1"># Use scaling_config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">constraint_manager</span> <span class="o">=</span> <span class="n">ResourceConstraintManager</span><span class="p">(</span>
            <span class="n">max_replicas</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>  <span class="c1"># Updated during build</span>
            <span class="n">memory_threshold</span><span class="o">=</span><span class="n">absolute_memory_threshold_mb</span><span class="p">,</span>
            <span class="n">memory_safety_buffer_fraction</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scaling_config</span><span class="o">.</span><span class="n">rcm_memory_safety_buffer_fraction</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;ResourceConstraintManager initialized using ScalingConfig.&quot;</span><span class="p">)</span>

        <span class="c1"># --- Instantiate Stats Collector ---</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stats_collection_interval_seconds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats_config</span><span class="o">.</span><span class="n">collection_interval_seconds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats_collector</span> <span class="o">=</span> <span class="n">RayStatsCollector</span><span class="p">(</span>
            <span class="n">pipeline_accessor</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>  <span class="c1"># This dependency remains for now</span>
            <span class="n">interval</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stats_config</span><span class="o">.</span><span class="n">collection_interval_seconds</span><span class="p">,</span>
            <span class="n">actor_timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stats_config</span><span class="o">.</span><span class="n">actor_timeout_seconds</span><span class="p">,</span>
            <span class="n">queue_timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stats_config</span><span class="o">.</span><span class="n">queue_timeout_seconds</span><span class="p">,</span>
            <span class="n">ema_alpha</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scaling_config</span><span class="o">.</span><span class="n">pid_ema_alpha</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;RayStatsCollector initialized using StatsConfig.&quot;</span><span class="p">)</span>

    <span class="c1"># --- Accessor Methods for Stat Collector (and internal use) ---</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Ensures the pipeline is stopped upon garbage collection.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Exception during RayPipeline cleanup: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="RayPipeline.get_stages_info">
<a class="viewcode-back" href="../../../../../../nv-ingest/nv_ingest.framework.orchestration.ray.primitives.html#nv_ingest.framework.orchestration.ray.primitives.ray_pipeline.RayPipeline.get_stages_info">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_stages_info</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">StageInfo</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a snapshot of the current stage information.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        List[StageInfo]</span>
<span class="sd">            A list of StageInfo objects from the topology.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">get_stages_info</span><span class="p">()</span></div>


<div class="viewcode-block" id="RayPipeline.get_stage_actors">
<a class="viewcode-back" href="../../../../../../nv-ingest/nv_ingest.framework.orchestration.ray.primitives.html#nv_ingest.framework.orchestration.ray.primitives.ray_pipeline.RayPipeline.get_stage_actors">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_stage_actors</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a snapshot of the current actors per stage.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Dict[str, List[Any]]</span>
<span class="sd">            A dictionary mapping stage names to lists of actor handles.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">get_stage_actors</span><span class="p">()</span></div>


<div class="viewcode-block" id="RayPipeline.get_edge_queues">
<a class="viewcode-back" href="../../../../../../nv-ingest/nv_ingest.framework.orchestration.ray.primitives.html#nv_ingest.framework.orchestration.ray.primitives.ray_pipeline.RayPipeline.get_edge_queues">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_edge_queues</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a snapshot of the current edge queues.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Dict[str, Tuple[Any, int]]</span>
<span class="sd">            A dictionary mapping queue names to tuples of (queue_handle, queue_size).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">get_edge_queues</span><span class="p">()</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_configure_autoscalers</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Updates controllers based on current pipeline configuration via topology.&quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;[Build-Configure] Configuring autoscalers...&quot;</span><span class="p">)</span>
        <span class="n">total_max_replicas</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">default_cost_bytes</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span>
        <span class="n">stage_overheads</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Collect locally</span>

        <span class="c1"># Use topology accessor</span>
        <span class="n">current_stages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">get_stages_info</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">stage</span> <span class="ow">in</span> <span class="n">current_stages</span><span class="p">:</span>
            <span class="n">total_max_replicas</span> <span class="o">+=</span> <span class="n">stage</span><span class="o">.</span><span class="n">max_replicas</span>
            <span class="c1"># Use estimated overhead if available (Assume it&#39;s calculated elsewhere or default)</span>
            <span class="c1"># For now, let&#39;s store a dummy overhead in topology during build</span>
            <span class="n">overhead_bytes</span> <span class="o">=</span> <span class="n">default_cost_bytes</span>  <span class="c1"># Simplification for now</span>
            <span class="n">stage_overheads</span><span class="p">[</span><span class="n">stage</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">overhead_bytes</span>  <span class="c1"># Store locally first</span>

        <span class="c1"># Update topology with collected overheads</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">set_stage_memory_overhead</span><span class="p">(</span><span class="n">stage_overheads</span><span class="p">)</span>

        <span class="c1"># Update constraint manager</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">constraint_manager</span><span class="o">.</span><span class="n">max_replicas</span> <span class="o">=</span> <span class="n">total_max_replicas</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Build-Configure] Autoscalers configured. Total Max Replicas: </span><span class="si">{</span><span class="n">total_max_replicas</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_instantiate_initial_actors</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Instantiates initial actors and updates topology.&quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;[Build-Actors] Instantiating initial stage actors (min_replicas)...&quot;</span><span class="p">)</span>
        <span class="c1"># Use topology accessor</span>
        <span class="n">current_stages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">get_stages_info</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">stage</span> <span class="ow">in</span> <span class="n">current_stages</span><span class="p">:</span>
            <span class="n">replicas</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamic_memory_scaling</span><span class="p">:</span>
                <span class="n">num_initial_actors</span> <span class="o">=</span> <span class="n">stage</span><span class="o">.</span><span class="n">max_replicas</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">num_initial_actors</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="nb">max</span><span class="p">(</span><span class="n">stage</span><span class="o">.</span><span class="n">min_replicas</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">stage</span><span class="o">.</span><span class="n">is_source</span> <span class="ow">or</span> <span class="n">stage</span><span class="o">.</span><span class="n">is_sink</span> <span class="k">else</span> <span class="n">stage</span><span class="o">.</span><span class="n">min_replicas</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">num_initial_actors</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Build-Actors] Stage &#39;</span><span class="si">{</span><span class="n">stage</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; creating </span><span class="si">{</span><span class="n">num_initial_actors</span><span class="si">}</span><span class="s2"> initial actor(s).&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_initial_actors</span><span class="p">):</span>
                    <span class="n">actor_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">stage</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;[Build-Actors] Creating actor &#39;</span><span class="si">{</span><span class="n">actor_name</span><span class="si">}</span><span class="s2">&#39; (</span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">num_initial_actors</span><span class="si">}</span><span class="s2">)&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot; for &#39;</span><span class="si">{</span><span class="n">stage</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
                    <span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">actor</span> <span class="o">=</span> <span class="n">stage</span><span class="o">.</span><span class="n">callable</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">actor_name</span><span class="p">,</span> <span class="n">max_concurrency</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_restarts</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">remote</span><span class="p">(</span>
                            <span class="n">config</span><span class="o">=</span><span class="n">stage</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">stage_name</span><span class="o">=</span><span class="n">stage</span><span class="o">.</span><span class="n">name</span>
                        <span class="p">)</span>
                        <span class="n">replicas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">actor</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Build-Actors] Failed create actor &#39;</span><span class="si">{</span><span class="n">actor_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Build failed: actor creation error for stage &#39;</span><span class="si">{</span><span class="n">stage</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

            <span class="c1"># Update topology for this stage</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">set_actors_for_stage</span><span class="p">(</span><span class="n">stage</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">replicas</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Build-Actors] Stage &#39;</span><span class="si">{</span><span class="n">stage</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; initial actors set in topology: count=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">replicas</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;[Build-Actors] Initial actor instantiation complete.&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_create_and_wire_edges</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ray</span><span class="o">.</span><span class="n">ObjectRef</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates queues, wires actors (using topology), and updates topology.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        List[ray.ObjectRef]</span>
<span class="sd">            A list of object references for the remote wiring calls.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;[Build-Wiring] Creating and wiring edges...&quot;</span><span class="p">)</span>
        <span class="n">wiring_refs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">new_edge_queues</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">current_connections</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">get_connections</span><span class="p">()</span>
        <span class="n">current_stage_actors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">get_stage_actors</span><span class="p">()</span>  <span class="c1"># Gets copy</span>

        <span class="k">for</span> <span class="n">from_stage_name</span><span class="p">,</span> <span class="n">connections_list</span> <span class="ow">in</span> <span class="n">current_connections</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">to_stage_name</span><span class="p">,</span> <span class="n">queue_size</span> <span class="ow">in</span> <span class="n">connections_list</span><span class="p">:</span>
                <span class="n">queue_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">from_stage_name</span><span class="si">}</span><span class="s2">_to_</span><span class="si">{</span><span class="n">to_stage_name</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Build-Wiring] Creating queue &#39;</span><span class="si">{</span><span class="n">queue_name</span><span class="si">}</span><span class="s2">&#39; (size </span><span class="si">{</span><span class="n">queue_size</span><span class="si">}</span><span class="s2">) and wiring.&quot;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">edge_queue</span> <span class="o">=</span> <span class="n">RayQueue</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="n">queue_size</span><span class="p">,</span> <span class="n">actor_options</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;max_restarts&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
                    <span class="n">new_edge_queues</span><span class="p">[</span><span class="n">queue_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">edge_queue</span><span class="p">,</span> <span class="n">queue_size</span><span class="p">)</span>

                    <span class="c1"># Wire using current actors from topology snapshot</span>
                    <span class="n">source_actors</span> <span class="o">=</span> <span class="n">current_stage_actors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">from_stage_name</span><span class="p">,</span> <span class="p">[])</span>
                    <span class="k">for</span> <span class="n">actor</span> <span class="ow">in</span> <span class="n">source_actors</span><span class="p">:</span>
                        <span class="n">wiring_refs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">actor</span><span class="o">.</span><span class="n">set_output_queue</span><span class="o">.</span><span class="n">remote</span><span class="p">(</span><span class="n">edge_queue</span><span class="p">))</span>

                    <span class="n">dest_actors</span> <span class="o">=</span> <span class="n">current_stage_actors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">to_stage_name</span><span class="p">,</span> <span class="p">[])</span>
                    <span class="k">for</span> <span class="n">actor</span> <span class="ow">in</span> <span class="n">dest_actors</span><span class="p">:</span>
                        <span class="n">wiring_refs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">actor</span><span class="o">.</span><span class="n">set_input_queue</span><span class="o">.</span><span class="n">remote</span><span class="p">(</span><span class="n">edge_queue</span><span class="p">))</span>

                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Build-Wiring] Failed create/wire queue &#39;</span><span class="si">{</span><span class="n">queue_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Build failed: queue wiring error for &#39;</span><span class="si">{</span><span class="n">queue_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

        <span class="c1"># Update topology with the new queues</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">set_edge_queues</span><span class="p">(</span><span class="n">new_edge_queues</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Build-Wiring] Submitted </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">wiring_refs</span><span class="p">)</span><span class="si">}</span><span class="s2"> wiring calls. Queues set in topology.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">wiring_refs</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_wait_for_wiring</span><span class="p">(</span><span class="n">wiring_refs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ray</span><span class="o">.</span><span class="n">ObjectRef</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Waits for remote wiring calls to complete.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        wiring_refs : List[ray.ObjectRef]</span>
<span class="sd">            A list of object references for the wiring calls.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">wiring_refs</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;[Build-WaitWiring] No wiring calls.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Build-WaitWiring] Waiting for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">wiring_refs</span><span class="p">)</span><span class="si">}</span><span class="s2"> wiring calls...&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ray</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">wiring_refs</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;[Build-WaitWiring] All wiring calls completed.&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Build-WaitWiring] Error during wiring confirmation: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Build failed: error confirming initial wiring&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

<div class="viewcode-block" id="RayPipeline.add_source">
<a class="viewcode-back" href="../../../../../../nv-ingest/nv_ingest.framework.orchestration.ray.primitives.html#nv_ingest.framework.orchestration.ray.primitives.ray_pipeline.RayPipeline.add_source">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_source</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">source_actor</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">min_replicas</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">max_replicas</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;RayPipeline&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds a source stage to the pipeline.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">            The name of the source stage.</span>
<span class="sd">        source_actor : Any</span>
<span class="sd">            The actor or callable for the source stage.</span>
<span class="sd">        config : BaseModel</span>
<span class="sd">            The configuration for the source stage.</span>
<span class="sd">        min_replicas : int, optional</span>
<span class="sd">            The minimum number of replicas for the source stage, by default 1.</span>
<span class="sd">        max_replicas : int, optional</span>
<span class="sd">            The maximum number of replicas for the source stage, by default 1.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        RayPipeline</span>
<span class="sd">            The pipeline instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">min_replicas</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Source stage &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;: min_replicas must be &gt;= 1. Overriding.&quot;</span><span class="p">)</span>
            <span class="n">min_replicas</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">stage_info</span> <span class="o">=</span> <span class="n">StageInfo</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="nb">callable</span><span class="o">=</span><span class="n">source_actor</span><span class="p">,</span>
            <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
            <span class="n">is_source</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">min_replicas</span><span class="o">=</span><span class="n">min_replicas</span><span class="p">,</span>
            <span class="n">max_replicas</span><span class="o">=</span><span class="n">max_replicas</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">add_stage</span><span class="p">(</span><span class="n">stage_info</span><span class="p">)</span>  <span class="c1"># Delegate</span>

        <span class="k">return</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="RayPipeline.add_stage">
<a class="viewcode-back" href="../../../../../../nv-ingest/nv_ingest.framework.orchestration.ray.primitives.html#nv_ingest.framework.orchestration.ray.primitives.ray_pipeline.RayPipeline.add_stage">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_stage</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">stage_actor</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="n">BaseModel</span><span class="p">,</span>
        <span class="n">min_replicas</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">max_replicas</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;RayPipeline&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds a stage to the pipeline.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">            The name of the stage.</span>
<span class="sd">        stage_actor : Any</span>
<span class="sd">            The actor or callable for the stage.</span>
<span class="sd">        config : BaseModel</span>
<span class="sd">            The configuration for the stage.</span>
<span class="sd">        min_replicas : int, optional</span>
<span class="sd">            The minimum number of replicas for the stage, by default 0.</span>
<span class="sd">        max_replicas : int, optional</span>
<span class="sd">            The maximum number of replicas for the stage, by default 1.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        RayPipeline</span>
<span class="sd">            The pipeline instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">min_replicas</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stage &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;: min_replicas cannot be negative. Overriding to 0.&quot;</span><span class="p">)</span>
            <span class="n">min_replicas</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">resolved_actor</span> <span class="o">=</span> <span class="n">stage_actor</span>

        <span class="c1"># Support module path (e.g., &quot;mypkg.mymodule:my_lambda&quot;)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stage_actor</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">resolved_actor</span> <span class="o">=</span> <span class="n">resolve_callable_from_path</span><span class="p">(</span>
                <span class="n">callable_path</span><span class="o">=</span><span class="n">stage_actor</span><span class="p">,</span> <span class="n">signature_schema</span><span class="o">=</span><span class="n">ingest_stage_callable_signature</span>
            <span class="p">)</span>

        <span class="c1"># Wrap callables</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">resolved_actor</span><span class="p">,</span> <span class="n">FunctionType</span><span class="p">):</span>
            <span class="n">schema_type</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
            <span class="n">resolved_actor</span> <span class="o">=</span> <span class="n">wrap_callable_as_stage</span><span class="p">(</span><span class="n">resolved_actor</span><span class="p">,</span> <span class="n">schema_type</span><span class="p">)</span>

        <span class="n">stage_info</span> <span class="o">=</span> <span class="n">StageInfo</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="nb">callable</span><span class="o">=</span><span class="n">resolved_actor</span><span class="p">,</span>
            <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
            <span class="n">min_replicas</span><span class="o">=</span><span class="n">min_replicas</span><span class="p">,</span>
            <span class="n">max_replicas</span><span class="o">=</span><span class="n">max_replicas</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">add_stage</span><span class="p">(</span><span class="n">stage_info</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="RayPipeline.add_sink">
<a class="viewcode-back" href="../../../../../../nv-ingest/nv_ingest.framework.orchestration.ray.primitives.html#nv_ingest.framework.orchestration.ray.primitives.ray_pipeline.RayPipeline.add_sink">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_sink</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">sink_actor</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">min_replicas</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">max_replicas</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;RayPipeline&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds a sink stage to the pipeline.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">            The name of the sink stage.</span>
<span class="sd">        sink_actor : Any</span>
<span class="sd">            The actor or callable for the sink stage.</span>
<span class="sd">        config : BaseModel</span>
<span class="sd">            The configuration for the sink stage.</span>
<span class="sd">        min_replicas : int, optional</span>
<span class="sd">            The minimum number of replicas for the sink stage, by default 1.</span>
<span class="sd">        max_replicas : int, optional</span>
<span class="sd">            The maximum number of replicas for the sink stage, by default 1.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        RayPipeline</span>
<span class="sd">            The pipeline instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Sink min_replicas can realistically be 0 if data drain is optional/best-effort? Let&#39;s allow 0.</span>
        <span class="k">if</span> <span class="n">min_replicas</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sink stage &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;: min_replicas cannot be negative. Overriding to 0.&quot;</span><span class="p">)</span>
            <span class="n">min_replicas</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">stage_info</span> <span class="o">=</span> <span class="n">StageInfo</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="nb">callable</span><span class="o">=</span><span class="n">sink_actor</span><span class="p">,</span>
            <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
            <span class="n">is_sink</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">min_replicas</span><span class="o">=</span><span class="n">min_replicas</span><span class="p">,</span>
            <span class="n">max_replicas</span><span class="o">=</span><span class="n">max_replicas</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">add_stage</span><span class="p">(</span><span class="n">stage_info</span><span class="p">)</span>  <span class="c1"># Delegate</span>

        <span class="k">return</span> <span class="bp">self</span></div>


    <span class="c1"># --- Method for defining connections ---</span>
<div class="viewcode-block" id="RayPipeline.make_edge">
<a class="viewcode-back" href="../../../../../../nv-ingest/nv_ingest.framework.orchestration.ray.primitives.html#nv_ingest.framework.orchestration.ray.primitives.ray_pipeline.RayPipeline.make_edge">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">make_edge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">from_stage</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">to_stage</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">queue_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;RayPipeline&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates an edge between two stages in the pipeline.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        from_stage : str</span>
<span class="sd">            The name of the source stage.</span>
<span class="sd">        to_stage : str</span>
<span class="sd">            The name of the destination stage.</span>
<span class="sd">        queue_size : int, optional</span>
<span class="sd">            The size of the queue between the stages, by default 100.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        RayPipeline</span>
<span class="sd">            The pipeline instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">add_connection</span><span class="p">(</span><span class="n">from_stage</span><span class="p">,</span> <span class="n">to_stage</span><span class="p">,</span> <span class="n">queue_size</span><span class="p">)</span>  <span class="c1"># Delegate (includes validation)</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;make_edge failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span>  <span class="c1"># Re-raise the error</span>
        <span class="k">return</span> <span class="bp">self</span></div>


    <span class="c1"># ----- Pipeline Build Process ---</span>
<div class="viewcode-block" id="RayPipeline.build">
<a class="viewcode-back" href="../../../../../../nv-ingest/nv_ingest.framework.orchestration.ray.primitives.html#nv_ingest.framework.orchestration.ray.primitives.ray_pipeline.RayPipeline.build">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Builds the pipeline: configures, instantiates, wires, using topology.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Dict[str, List[Any]]</span>
<span class="sd">            A dictionary mapping stage names to lists of actor handles.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;--- Starting Pipeline Build Process ---&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">get_stages_info</span><span class="p">():</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Build failed: No stages defined in topology.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">{}</span>

            <span class="c1"># Steps interact with self.topology</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_configure_autoscalers</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_instantiate_initial_actors</span><span class="p">()</span>
            <span class="n">wiring_futures</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_and_wire_edges</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_wait_for_wiring</span><span class="p">(</span><span class="n">wiring_futures</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;--- Pipeline Build Completed Successfully ---&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">get_stage_actors</span><span class="p">()</span>  <span class="c1"># Return actors from topology</span>

        <span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pipeline build failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="c1"># Clean up topology runtime state?</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">clear_runtime_state</span><span class="p">()</span>
            <span class="k">return</span> <span class="p">{}</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error during pipeline build: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">clear_runtime_state</span><span class="p">()</span>
            <span class="k">return</span> <span class="p">{}</span></div>


    <span class="c1"># --- Scaling Logic ---</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_create_single_replica</span><span class="p">(</span><span class="n">stage_info</span><span class="p">:</span> <span class="n">StageInfo</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a single new Ray actor replica for the given stage.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        stage_info : StageInfo</span>
<span class="sd">            The stage information.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Any</span>
<span class="sd">            The new actor handle.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">actor_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">stage_info</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ScaleUtil] Creating new actor &#39;</span><span class="si">{</span><span class="n">actor_name</span><span class="si">}</span><span class="s2">&#39; for stage &#39;</span><span class="si">{</span><span class="n">stage_info</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">new_actor</span> <span class="o">=</span> <span class="n">stage_info</span><span class="o">.</span><span class="n">callable</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">actor_name</span><span class="p">,</span> <span class="n">max_concurrency</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_restarts</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">remote</span><span class="p">(</span>
                <span class="n">config</span><span class="o">=</span><span class="n">stage_info</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">stage_name</span><span class="o">=</span><span class="n">stage_info</span><span class="o">.</span><span class="n">name</span>
            <span class="p">)</span>

            <span class="k">return</span> <span class="n">new_actor</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;[ScaleUtil] Failed to create actor &#39;</span><span class="si">{</span><span class="n">actor_name</span><span class="si">}</span><span class="s2">&#39; for stage &#39;</span><span class="si">{</span><span class="n">stage_info</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;:&quot;</span> <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Propagate error to halt the scaling operation</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Actor creation failed for stage &#39;</span><span class="si">{</span><span class="n">stage_info</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; during scale up&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_wiring_refs_for_actor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">actor</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">stage_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ray</span><span class="o">.</span><span class="n">ObjectRef</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets wiring futures for a single actor using topology for queues/connections.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        actor : Any</span>
<span class="sd">            The actor handle.</span>
<span class="sd">        stage_name : str</span>
<span class="sd">            The name of the stage.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        List[ray.ObjectRef]</span>
<span class="sd">            A list of object references for the wiring calls.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">wiring_refs</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Use topology accessors</span>
        <span class="n">connections</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">get_connections</span><span class="p">()</span>
        <span class="n">edge_queues</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">get_edge_queues</span><span class="p">()</span>

        <span class="c1"># Wire outputs</span>
        <span class="k">if</span> <span class="n">stage_name</span> <span class="ow">in</span> <span class="n">connections</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">to_stage</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">connections</span><span class="p">[</span><span class="n">stage_name</span><span class="p">]:</span>
                <span class="n">queue_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">stage_name</span><span class="si">}</span><span class="s2">_to_</span><span class="si">{</span><span class="n">to_stage</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">if</span> <span class="n">queue_name</span> <span class="ow">in</span> <span class="n">edge_queues</span><span class="p">:</span>
                    <span class="n">edge_queue</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">edge_queues</span><span class="p">[</span><span class="n">queue_name</span><span class="p">]</span>
                    <span class="n">wiring_refs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">actor</span><span class="o">.</span><span class="n">set_output_queue</span><span class="o">.</span><span class="n">remote</span><span class="p">(</span><span class="n">edge_queue</span><span class="p">))</span>

        <span class="c1"># Wire inputs</span>
        <span class="k">for</span> <span class="n">from_stage</span><span class="p">,</span> <span class="n">conns</span> <span class="ow">in</span> <span class="n">connections</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">to_stage</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">conns</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">to_stage</span> <span class="o">==</span> <span class="n">stage_name</span><span class="p">:</span>
                    <span class="n">queue_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">from_stage</span><span class="si">}</span><span class="s2">_to_</span><span class="si">{</span><span class="n">stage_name</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="k">if</span> <span class="n">queue_name</span> <span class="ow">in</span> <span class="n">edge_queues</span><span class="p">:</span>
                        <span class="n">edge_queue</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">edge_queues</span><span class="p">[</span><span class="n">queue_name</span><span class="p">]</span>
                        <span class="n">wiring_refs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">actor</span><span class="o">.</span><span class="n">set_input_queue</span><span class="o">.</span><span class="n">remote</span><span class="p">(</span><span class="n">edge_queue</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">wiring_refs</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_start_actors</span><span class="p">(</span><span class="n">actors_to_start</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">stage_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Starts a list of actors if they have a &#39;start&#39; method and waits for completion.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        actors_to_start : List[Any]</span>
<span class="sd">            A list of actor handles.</span>
<span class="sd">        stage_name : str</span>
<span class="sd">            The name of the stage.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">start_refs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">actor</span> <span class="ow">in</span> <span class="n">actors_to_start</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">actor</span><span class="p">,</span> <span class="s2">&quot;start&quot;</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ScaleUtil] Starting actor &#39;</span><span class="si">{</span><span class="n">actor</span><span class="si">}</span><span class="s2">&#39; for stage &#39;</span><span class="si">{</span><span class="n">stage_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
                <span class="n">start_refs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">actor</span><span class="o">.</span><span class="n">start</span><span class="o">.</span><span class="n">remote</span><span class="p">())</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">start_refs</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ScaleUtil] No actors with start() method found for stage &#39;</span><span class="si">{</span><span class="n">stage_name</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ScaleUtil] Waiting for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">start_refs</span><span class="p">)</span><span class="si">}</span><span class="s2"> actor starts for stage &#39;</span><span class="si">{</span><span class="n">stage_name</span><span class="si">}</span><span class="s2">&#39;...&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ray</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">start_refs</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ScaleUtil] </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">start_refs</span><span class="p">)</span><span class="si">}</span><span class="s2"> actors started successfully for stage &#39;</span><span class="si">{</span><span class="n">stage_name</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;[ScaleUtil] Error waiting for actors to start for stage &#39;</span><span class="si">{</span><span class="n">stage_name</span><span class="si">}</span><span class="s2">&#39;:&quot;</span> <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="c1"># Note: Actors might be started but confirmation failed. State might be inconsistent.</span>
            <span class="c1"># Consider raising an error to signal potential inconsistency?</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error confirming actor starts for stage &#39;</span><span class="si">{</span><span class="n">stage_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_handle_scale_up</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stage_info</span><span class="p">:</span> <span class="n">StageInfo</span><span class="p">,</span> <span class="n">current_count</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">target_count</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handles scaling up, interacting with topology.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        stage_info : StageInfo</span>
<span class="sd">            The stage information.</span>
<span class="sd">        current_count : int</span>
<span class="sd">            The current number of replicas.</span>
<span class="sd">        target_count : int</span>
<span class="sd">            The target number of replicas.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">stage_name</span> <span class="o">=</span> <span class="n">stage_info</span><span class="o">.</span><span class="n">name</span>
        <span class="n">num_to_add</span> <span class="o">=</span> <span class="n">target_count</span> <span class="o">-</span> <span class="n">current_count</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ScaleUp-</span><span class="si">{</span><span class="n">stage_name</span><span class="si">}</span><span class="s2">] Scaling up from </span><span class="si">{</span><span class="n">current_count</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">target_count</span><span class="si">}</span><span class="s2"> (+</span><span class="si">{</span><span class="n">num_to_add</span><span class="si">}</span><span class="s2">).&quot;</span><span class="p">)</span>
        <span class="c1"># Update topology state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">update_scaling_state</span><span class="p">(</span><span class="n">stage_name</span><span class="p">,</span> <span class="s2">&quot;Scaling Up&quot;</span><span class="p">)</span>

        <span class="n">new_actors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">all_wiring_refs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">successfully_added_actors</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># 1. Create actors</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_to_add</span><span class="p">):</span>
                <span class="n">new_actor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_single_replica</span><span class="p">(</span><span class="n">stage_info</span><span class="p">)</span>
                <span class="n">new_actors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_actor</span><span class="p">)</span>

            <span class="c1"># 2. Get wiring refs (uses topology internally)</span>
            <span class="k">for</span> <span class="n">actor</span> <span class="ow">in</span> <span class="n">new_actors</span><span class="p">:</span>
                <span class="n">all_wiring_refs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_wiring_refs_for_actor</span><span class="p">(</span><span class="n">actor</span><span class="p">,</span> <span class="n">stage_name</span><span class="p">))</span>

            <span class="c1"># 3. Wait for wiring (static helper)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_wait_for_wiring</span><span class="p">(</span><span class="n">all_wiring_refs</span><span class="p">)</span>  <span class="c1"># Handles errors</span>

            <span class="c1"># 4. Start actors (static helper)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_start_actors</span><span class="p">(</span><span class="n">new_actors</span><span class="p">,</span> <span class="n">stage_name</span><span class="p">)</span>  <span class="c1"># Handles errors</span>

            <span class="c1"># 5. Add successfully created/wired/started actors to topology</span>
            <span class="k">for</span> <span class="n">actor</span> <span class="ow">in</span> <span class="n">new_actors</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">add_actor_to_stage</span><span class="p">(</span><span class="n">stage_name</span><span class="p">,</span> <span class="n">actor</span><span class="p">)</span>
                <span class="n">successfully_added_actors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">actor</span><span class="p">)</span>  <span class="c1"># Keep track</span>

            <span class="n">final_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">get_actor_count</span><span class="p">(</span><span class="n">stage_name</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;[ScaleUp-</span><span class="si">{</span><span class="n">stage_name</span><span class="si">}</span><span class="s2">] Scale up complete. Added </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">successfully_added_actors</span><span class="p">)</span><span class="si">}</span><span class="s2">. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;New count: </span><span class="si">{</span><span class="n">final_count</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ScaleUp-</span><span class="si">{</span><span class="n">stage_name</span><span class="si">}</span><span class="s2">] Error during scale up: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">update_scaling_state</span><span class="p">(</span><span class="n">stage_name</span><span class="p">,</span> <span class="s2">&quot;Error&quot;</span><span class="p">)</span>
            <span class="c1"># --- Cleanup Attempt ---</span>
            <span class="c1"># Actors created but potentially not wired/started/added to topology.</span>
            <span class="c1"># Only kill actors that were definitely *not* added to the topology.</span>
            <span class="n">actors_to_kill</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">new_actors</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">successfully_added_actors</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">actors_to_kill</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;[ScaleUp-</span><span class="si">{</span><span class="n">stage_name</span><span class="si">}</span><span class="s2">] Attempting to kill </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">actors_to_kill</span><span class="p">)</span><span class="si">}</span><span class="s2"> partially created actors.&quot;</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">actor</span> <span class="ow">in</span> <span class="n">actors_to_kill</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">ray</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="n">actor</span><span class="p">,</span> <span class="n">no_restart</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">kill_e</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to kill actor </span><span class="si">{</span><span class="n">actor</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">kill_e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ScaleUp-</span><span class="si">{</span><span class="n">stage_name</span><span class="si">}</span><span class="s2">] Scale up failed. State potentially inconsistent.&quot;</span><span class="p">)</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># Reset state only if it was Scaling Up and didn&#39;t end in Error</span>
            <span class="n">current_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">get_scaling_state</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">stage_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">current_state</span> <span class="o">==</span> <span class="s2">&quot;Scaling Up&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">update_scaling_state</span><span class="p">(</span><span class="n">stage_name</span><span class="p">,</span> <span class="s2">&quot;Idle&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_handle_scale_down</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stage_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">current_replicas</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">target_count</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handles scaling down: initiates stop on actors and marks them for removal</span>
<span class="sd">        by the topology&#39;s garbage collection mechanism.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        stage_name : str</span>
<span class="sd">            The name of the stage.</span>
<span class="sd">        current_replicas : List[Any]</span>
<span class="sd">            A list of actor handles.</span>
<span class="sd">        target_count : int</span>
<span class="sd">            The target number of replicas.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">current_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">current_replicas</span><span class="p">)</span>
        <span class="n">num_to_remove</span> <span class="o">=</span> <span class="n">current_count</span> <span class="o">-</span> <span class="n">target_count</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;[ScaleDown-</span><span class="si">{</span><span class="n">stage_name</span><span class="si">}</span><span class="s2">] Scaling down from </span><span class="si">{</span><span class="n">current_count</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">target_count</span><span class="si">}</span><span class="s2"> (-</span><span class="si">{</span><span class="n">num_to_remove</span><span class="si">}</span><span class="s2">).&quot;</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">num_to_remove</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Select actors to remove (e.g., the most recently added)</span>
        <span class="n">actors_to_remove</span> <span class="o">=</span> <span class="n">current_replicas</span><span class="p">[</span><span class="o">-</span><span class="n">num_to_remove</span><span class="p">:]</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ScaleDown-</span><span class="si">{</span><span class="n">stage_name</span><span class="si">}</span><span class="s2">] Selected </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">actors_to_remove</span><span class="p">)</span><span class="si">}</span><span class="s2"> actors for removal.&quot;</span><span class="p">)</span>

        <span class="c1"># Signal each actor to stop and mark it for removal by the topology.</span>
        <span class="c1"># The topology&#39;s cleanup thread will handle polling and final removal.</span>
        <span class="k">for</span> <span class="n">actor</span> <span class="ow">in</span> <span class="n">actors_to_remove</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">actor</span><span class="o">.</span><span class="n">stop</span><span class="o">.</span><span class="n">remote</span><span class="p">()</span>  <span class="c1"># Signal the actor&#39;s loop to stop</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">mark_actor_for_removal</span><span class="p">(</span><span class="n">stage_name</span><span class="p">,</span> <span class="n">actor</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ScaleDown-</span><span class="si">{</span><span class="n">stage_name</span><span class="si">}</span><span class="s2">] Failed to initiate stop for actor </span><span class="si">{</span><span class="n">actor</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ScaleDown-</span><span class="si">{</span><span class="n">stage_name</span><span class="si">}</span><span class="s2">] Scale down initiation complete for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">actors_to_remove</span><span class="p">)</span><span class="si">}</span><span class="s2"> actors.&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_scale_stage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stage_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">new_replica_count</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Orchestrates scaling using topology for state and info.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        stage_name : str</span>
<span class="sd">            The name of the stage.</span>
<span class="sd">        new_replica_count : int</span>
<span class="sd">            The new number of replicas.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ScaleStage-</span><span class="si">{</span><span class="n">stage_name</span><span class="si">}</span><span class="s2">] Request for target count: </span><span class="si">{</span><span class="n">new_replica_count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># --- Use Topology Accessors ---</span>
        <span class="n">stage_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">get_stage_info</span><span class="p">(</span><span class="n">stage_name</span><span class="p">)</span>
        <span class="n">current_replicas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">get_stage_actors</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">stage_name</span><span class="p">,</span> <span class="p">[])</span>  <span class="c1"># Get current actors safely</span>
        <span class="n">current_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">current_replicas</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">stage_info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ScaleStage-</span><span class="si">{</span><span class="n">stage_name</span><span class="si">}</span><span class="s2">] Stage info not found. Cannot scale.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">target_count</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">stage_info</span><span class="o">.</span><span class="n">min_replicas</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">new_replica_count</span><span class="p">,</span> <span class="n">stage_info</span><span class="o">.</span><span class="n">max_replicas</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">target_count</span> <span class="o">!=</span> <span class="n">new_replica_count</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;[ScaleStage-</span><span class="si">{</span><span class="n">stage_name</span><span class="si">}</span><span class="s2">] Count </span><span class="si">{</span><span class="n">new_replica_count</span><span class="si">}</span><span class="s2"> adjusted to </span><span class="si">{</span><span class="n">target_count</span><span class="si">}</span><span class="s2"> &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;by bounds (</span><span class="si">{</span><span class="n">stage_info</span><span class="o">.</span><span class="n">min_replicas</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">stage_info</span><span class="o">.</span><span class="n">max_replicas</span><span class="si">}</span><span class="s2">).&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">target_count</span> <span class="o">==</span> <span class="n">current_count</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ScaleStage-</span><span class="si">{</span><span class="n">stage_name</span><span class="si">}</span><span class="s2">] Already at target count (</span><span class="si">{</span><span class="n">current_count</span><span class="si">}</span><span class="s2">). No action.&quot;</span><span class="p">)</span>
            <span class="c1"># Reset state if needed</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">get_scaling_state</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">stage_name</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;Idle&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">update_scaling_state</span><span class="p">(</span><span class="n">stage_name</span><span class="p">,</span> <span class="s2">&quot;Idle&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># --- Delegate ---</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">target_count</span> <span class="o">&gt;</span> <span class="n">current_count</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_handle_scale_up</span><span class="p">(</span><span class="n">stage_info</span><span class="p">,</span> <span class="n">current_count</span><span class="p">,</span> <span class="n">target_count</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># target_count &lt; current_count</span>
                <span class="c1"># Pass the list of actors we know about *now*</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_handle_scale_down</span><span class="p">(</span><span class="n">stage_name</span><span class="p">,</span> <span class="n">current_replicas</span><span class="p">,</span> <span class="n">target_count</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  <span class="c1"># Catch specific errors from handlers</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ScaleStage-</span><span class="si">{</span><span class="n">stage_name</span><span class="si">}</span><span class="s2">] Scaling failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="c1"># State should have been set to &quot;Error&quot; within the handler</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ScaleStage-</span><span class="si">{</span><span class="n">stage_name</span><span class="si">}</span><span class="s2">] Unexpected error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">update_scaling_state</span><span class="p">(</span><span class="n">stage_name</span><span class="p">,</span> <span class="s2">&quot;Error&quot;</span><span class="p">)</span>  <span class="c1"># Ensure error state</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_is_pipeline_quiet</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks if pipeline is quiet using topology state and stats collector.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            True if the pipeline is quiet, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">False</span>  <span class="c1"># TODO: disabled for debugging</span>

        <span class="c1"># Check topology state first</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">get_is_flushing</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Pipeline quiet check: False (Flush in progress via topology state)&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Check stats collector for recent activity</span>
        <span class="n">latest_stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats_collector</span><span class="o">.</span><span class="n">get_latest_stats</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">latest_stats</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Pipeline quiet check: True (No stats available, assuming quiet)&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>  <span class="c1"># No stats could mean it&#39;s idle</span>

        <span class="n">total_in_flight</span> <span class="o">=</span> <span class="n">latest_stats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;total_items_in_flight&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pipeline quiet check: Total in-flight items: </span><span class="si">{</span><span class="n">total_in_flight</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">total_in_flight</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet_period_threshold</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_wait_for_pipeline_drain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Actively monitors pipeline drain using direct calls to the stats collector.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        timeout_seconds : int</span>
<span class="sd">            The timeout in seconds.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            True if the pipeline drained successfully, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Waiting for pipeline drain (Timeout: </span><span class="si">{</span><span class="n">timeout_seconds</span><span class="si">}</span><span class="s2">s)...&quot;</span><span class="p">)</span>
        <span class="n">last_in_flight</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">drain_check_interval</span> <span class="o">=</span> <span class="mf">1.0</span>  <span class="c1"># Check every second</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">current_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">elapsed_time</span> <span class="o">=</span> <span class="n">current_time</span> <span class="o">-</span> <span class="n">start_time</span>

            <span class="k">if</span> <span class="n">elapsed_time</span> <span class="o">&gt;=</span> <span class="n">timeout_seconds</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pipeline drain timed out after </span><span class="si">{</span><span class="n">elapsed_time</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">s. Last In-Flight: </span><span class="si">{</span><span class="n">last_in_flight</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="c1"># --- Trigger immediate stats collection via the collector instance ---</span>
            <span class="n">drain_success</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">collection_error</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">global_in_flight</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Use the collector&#39;s method for a one-off, blocking collection</span>
                <span class="n">drain_stats</span><span class="p">,</span> <span class="n">global_in_flight</span><span class="p">,</span> <span class="n">drain_success</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats_collector</span><span class="o">.</span><span class="n">collect_stats_now</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DrainWait] Critical error during direct stats collection call: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">collection_error</span> <span class="o">=</span> <span class="n">e</span>  <span class="c1"># Indicate failure to even run collection</span>

            <span class="c1"># --- Process collection results ---</span>
            <span class="k">if</span> <span class="n">global_in_flight</span> <span class="o">!=</span> <span class="n">last_in_flight</span><span class="p">:</span>
                <span class="n">status_msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Collection Success: </span><span class="si">{</span><span class="n">drain_success</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">collection_error</span>
                    <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;Collection Error: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">collection_error</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;[Drain] Check at </span><span class="si">{</span><span class="n">elapsed_time</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">s: Global In-Flight=</span><span class="si">{</span><span class="n">global_in_flight</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">status_msg</span><span class="si">}</span><span class="s2">)&quot;</span>
                <span class="p">)</span>
                <span class="n">last_in_flight</span> <span class="o">=</span> <span class="n">global_in_flight</span>

            <span class="c1"># --- Check for successful drain ---</span>
            <span class="c1"># Requires BOTH in-flight=0 AND the collection reporting it was successful</span>
            <span class="k">if</span> <span class="n">global_in_flight</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">drain_success</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">collection_error</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="n">global_in_flight</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Saw zero, but collection wasn&#39;t fully successful</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;[Drain] In-Flight reached 0, but stats collection had errors/timeouts.&quot;</span>
                    <span class="s2">&quot; Cannot confirm drain yet.&quot;</span>
                <span class="p">)</span>

            <span class="c1"># --- Wait ---</span>
            <span class="n">remaining_time</span> <span class="o">=</span> <span class="n">timeout_seconds</span> <span class="o">-</span> <span class="n">elapsed_time</span>
            <span class="n">sleep_duration</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">drain_check_interval</span><span class="p">,</span> <span class="n">remaining_time</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>  <span class="c1"># Ensure positive sleep</span>
            <span class="k">if</span> <span class="n">sleep_duration</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">sleep_duration</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_execute_queue_flush</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Executes queue flush, using topology for state and structure.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            True if the flush was successful, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">get_is_flushing</span><span class="p">()</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stopping</span><span class="p">:</span>  <span class="c1"># Check topology state</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Queue flush requested but already in progress or pipeline is stopping. Ignoring.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Set flushing state in topology</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">set_flushing</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">overall_success</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">source_actors_paused</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">pause_refs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">new_edge_queues_map</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># --- Get structure snapshots from topology ---</span>
            <span class="c1"># Use lock context for multiple reads if needed, but individual accessors are locked too</span>
            <span class="n">current_stages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">get_stages_info</span><span class="p">()</span>
            <span class="n">current_stage_actors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">get_stage_actors</span><span class="p">()</span>
            <span class="n">current_edge_queues</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">get_edge_queues</span><span class="p">()</span>
            <span class="n">current_connections</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">get_connections</span><span class="p">()</span>

            <span class="c1"># --- 1. Pause Source Stages (using snapshots) ---</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Pausing source stages...&quot;</span><span class="p">)</span>
            <span class="n">pause_timeout</span> <span class="o">=</span> <span class="mf">60.0</span>
            <span class="k">for</span> <span class="n">stage</span> <span class="ow">in</span> <span class="n">current_stages</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">stage</span><span class="o">.</span><span class="n">is_source</span><span class="p">:</span>
                    <span class="n">actors</span> <span class="o">=</span> <span class="n">current_stage_actors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">stage</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="p">[])</span>
                    <span class="k">for</span> <span class="n">actor</span> <span class="ow">in</span> <span class="n">actors</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">actor</span><span class="p">,</span> <span class="s2">&quot;pause&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">actor</span><span class="o">.</span><span class="n">pause</span><span class="p">,</span> <span class="s2">&quot;remote&quot;</span><span class="p">):</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">pause_refs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">actor</span><span class="o">.</span><span class="n">pause</span><span class="o">.</span><span class="n">remote</span><span class="p">())</span>
                                <span class="n">source_actors_paused</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">actor</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed sending pause to </span><span class="si">{</span><span class="n">actor</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">pause_refs</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Waiting up to </span><span class="si">{</span><span class="n">pause_timeout</span><span class="si">}</span><span class="s2">s for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">pause_refs</span><span class="p">)</span><span class="si">}</span><span class="s2"> sources to pause...&quot;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ray</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pause_refs</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">pause_timeout</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">pause_refs</span><span class="p">)</span><span class="si">}</span><span class="s2"> sources acknowledged pause.&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">GetTimeoutError</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Timeout waiting for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">pause_refs</span><span class="p">)</span><span class="si">}</span><span class="s2"> sources to pause.&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error waiting for sources pause: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. Proceeding cautiously.&quot;</span><span class="p">)</span>

            <span class="c1"># --- 2. Wait for Drain ---</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Waiting for pipeline to drain...&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wait_for_pipeline_drain</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">queue_flush_drain_timeout_seconds</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Pipeline drain failed or timed out, aborting flush.&quot;</span><span class="p">)</span>

            <span class="c1"># --- 3. Create New Queues (using snapshot) ---</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Creating new replacement queues...&quot;</span><span class="p">)</span>
            <span class="n">new_edge_queues_map</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">queue_name</span><span class="p">,</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">queue_size</span><span class="p">)</span> <span class="ow">in</span> <span class="n">current_edge_queues</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">new_edge_queues_map</span><span class="p">[</span><span class="n">queue_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">RayQueue</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="n">queue_size</span><span class="p">,</span> <span class="n">actor_options</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;max_restarts&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}),</span>
                        <span class="n">queue_size</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created new queue: </span><span class="si">{</span><span class="n">queue_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to create new queue &#39;</span><span class="si">{</span><span class="n">queue_name</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

            <span class="c1"># --- 4. Re-wire Actors to New Queues (using snapshots) ---</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Re-wiring actors to new queues...&quot;</span><span class="p">)</span>
            <span class="n">wiring_refs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">wiring_timeout</span> <span class="o">=</span> <span class="mf">120.0</span>
            <span class="k">for</span> <span class="n">from_stage_name</span><span class="p">,</span> <span class="n">conns</span> <span class="ow">in</span> <span class="n">current_connections</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">to_stage_name</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">conns</span><span class="p">:</span>
                    <span class="n">queue_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">from_stage_name</span><span class="si">}</span><span class="s2">_to_</span><span class="si">{</span><span class="n">to_stage_name</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="k">if</span> <span class="n">queue_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">new_edge_queues_map</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;New queue missing for </span><span class="si">{</span><span class="n">queue_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">new_queue_actor</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">new_edge_queues_map</span><span class="p">[</span><span class="n">queue_name</span><span class="p">]</span>

                    <span class="c1"># Re-wire sources outputs</span>
                    <span class="k">for</span> <span class="n">actor</span> <span class="ow">in</span> <span class="n">current_stage_actors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">from_stage_name</span><span class="p">,</span> <span class="p">[]):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">wiring_refs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">actor</span><span class="o">.</span><span class="n">set_output_queue</span><span class="o">.</span><span class="n">remote</span><span class="p">(</span><span class="n">new_queue_actor</span><span class="p">))</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed sending set_output_queue to </span><span class="si">{</span><span class="n">actor</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                    <span class="c1"># Re-wire destinations inputs</span>
                    <span class="k">for</span> <span class="n">actor</span> <span class="ow">in</span> <span class="n">current_stage_actors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">to_stage_name</span><span class="p">,</span> <span class="p">[]):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">wiring_refs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">actor</span><span class="o">.</span><span class="n">set_input_queue</span><span class="o">.</span><span class="n">remote</span><span class="p">(</span><span class="n">new_queue_actor</span><span class="p">))</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed sending set_input_queue to </span><span class="si">{</span><span class="n">actor</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">wiring_refs</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Waiting up to </span><span class="si">{</span><span class="n">wiring_timeout</span><span class="si">}</span><span class="s2">s for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">wiring_refs</span><span class="p">)</span><span class="si">}</span><span class="s2"> actors to re-wire...&quot;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ready</span><span class="p">,</span> <span class="n">not_ready</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">wiring_refs</span><span class="p">,</span> <span class="n">num_returns</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">wiring_refs</span><span class="p">),</span> <span class="n">timeout</span><span class="o">=</span><span class="n">wiring_timeout</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">not_ready</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Actor re-wiring timed out or failed.&quot;</span><span class="p">)</span>
                    <span class="n">ray</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ready</span><span class="p">)</span>  <span class="c1"># Check for internal errors</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ready</span><span class="p">)</span><span class="si">}</span><span class="s2"> actors re-wired successfully.&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Actor re-wiring failed.&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

            <span class="c1"># --- 5. Update Topology State (Commit Point) ---</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Committing new queues to pipeline topology.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">set_edge_queues</span><span class="p">(</span><span class="n">new_edge_queues_map</span><span class="p">)</span>  <span class="c1"># Commit the change</span>
            <span class="n">overall_success</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error during queue flush: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">overall_success</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># --- 6. Resume Source Stages (Always attempt) ---</span>
            <span class="k">if</span> <span class="n">source_actors_paused</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Attempting to resume </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">source_actors_paused</span><span class="p">)</span><span class="si">}</span><span class="s2"> source actors...&quot;</span><span class="p">)</span>
                <span class="n">resume_timeout</span> <span class="o">=</span> <span class="mf">30.0</span>
                <span class="n">resume_refs</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">actor</span> <span class="ow">in</span> <span class="n">source_actors_paused</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">resume_refs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">actor</span><span class="o">.</span><span class="n">resume</span><span class="o">.</span><span class="n">remote</span><span class="p">())</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed sending resume to </span><span class="si">{</span><span class="n">actor</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">resume_refs</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Waiting up to </span><span class="si">{</span><span class="n">resume_timeout</span><span class="si">}</span><span class="s2">s for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">resume_refs</span><span class="p">)</span><span class="si">}</span><span class="s2"> actors to resume...&quot;</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">ray</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">resume_refs</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">resume_timeout</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">resume_refs</span><span class="p">)</span><span class="si">}</span><span class="s2"> sources resumed.&quot;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="n">GetTimeoutError</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Timeout waiting for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">resume_refs</span><span class="p">)</span><span class="si">}</span><span class="s2"> sources to resume.&quot;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error waiting for sources resume: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Update flush timestamp only on success</span>
            <span class="k">if</span> <span class="n">overall_success</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_last_queue_flush_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

            <span class="c1"># Reset flushing state in topology</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">set_flushing</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">overall_success</span>

<div class="viewcode-block" id="RayPipeline.request_queue_flush">
<a class="viewcode-back" href="../../../../../../nv-ingest/nv_ingest.framework.orchestration.ray.primitives.html#nv_ingest.framework.orchestration.ray.primitives.ray_pipeline.RayPipeline.request_queue_flush">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">request_queue_flush</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Requests a queue flush, checking topology state.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        force : bool, optional</span>
<span class="sd">            Whether to force the flush, by default False.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Manual queue flush requested (force=</span><span class="si">{</span><span class="n">force</span><span class="si">}</span><span class="s2">).&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">get_is_flushing</span><span class="p">()</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stopping</span><span class="p">:</span>  <span class="c1"># Check topology</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Flush already in progress or pipeline is stopping.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">force</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_pipeline_quiet</span><span class="p">():</span>
            <span class="c1"># Consider running _execute_queue_flush in a separate thread</span>
            <span class="c1"># to avoid blocking the caller, especially if &#39;force=True&#39;.</span>
            <span class="c1"># For now, run synchronously:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_execute_queue_flush</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Manual flush denied: pipeline not quiet or interval not met.&quot;</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_gather_controller_metrics</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">current_stage_stats</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]],</span> <span class="n">global_in_flight</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gathers metrics using provided stats and topology.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        current_stage_stats : Dict[str, Dict[str, int]]</span>
<span class="sd">            The current stage statistics.</span>
<span class="sd">        global_in_flight : int</span>
<span class="sd">            The global in-flight count.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Dict[str, Dict[str, Any]]</span>
<span class="sd">            A dictionary of metrics for the controllers.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;[ScalingMetrics] Gathering metrics for controllers...&quot;</span><span class="p">)</span>
        <span class="n">current_stage_metrics</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Use topology accessors</span>
        <span class="n">current_stages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">get_stages_info</span><span class="p">()</span>
        <span class="n">current_actors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">get_stage_actors</span><span class="p">()</span>  <span class="c1"># Snapshot</span>

        <span class="k">for</span> <span class="n">stage</span> <span class="ow">in</span> <span class="n">current_stages</span><span class="p">:</span>
            <span class="n">stage_name</span> <span class="o">=</span> <span class="n">stage</span><span class="o">.</span><span class="n">name</span>
            <span class="n">replicas</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">current_actors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">stage_name</span><span class="p">,</span> <span class="p">[]))</span>
            <span class="n">stats</span> <span class="o">=</span> <span class="n">current_stage_stats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">stage_name</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;processing&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;in_flight&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
            <span class="n">processing</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;processing&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">in_flight</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;in_flight&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">queue_depth</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">in_flight</span> <span class="o">-</span> <span class="n">processing</span><span class="p">)</span>

            <span class="n">current_stage_metrics</span><span class="p">[</span><span class="n">stage_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;replicas&quot;</span><span class="p">:</span> <span class="n">replicas</span><span class="p">,</span>
                <span class="s2">&quot;queue_depth&quot;</span><span class="p">:</span> <span class="n">queue_depth</span><span class="p">,</span>
                <span class="s2">&quot;processing&quot;</span><span class="p">:</span> <span class="n">processing</span><span class="p">,</span>
                <span class="s2">&quot;in_flight&quot;</span><span class="p">:</span> <span class="n">in_flight</span><span class="p">,</span>
                <span class="s2">&quot;min_replicas&quot;</span><span class="p">:</span> <span class="n">stage</span><span class="o">.</span><span class="n">min_replicas</span><span class="p">,</span>
                <span class="s2">&quot;max_replicas&quot;</span><span class="p">:</span> <span class="n">stage</span><span class="o">.</span><span class="n">max_replicas</span><span class="p">,</span>
                <span class="s2">&quot;pipeline_in_flight&quot;</span><span class="p">:</span> <span class="n">global_in_flight</span><span class="p">,</span>
            <span class="p">}</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ScalingMetrics] Gathered metrics for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">current_stage_metrics</span><span class="p">)</span><span class="si">}</span><span class="s2"> stages.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">current_stage_metrics</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_current_global_memory</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Safely retrieves the current global system memory usage (used, not free) in MB.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        int</span>
<span class="sd">            The current global memory usage (RSS/used) in MB.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># psutil.virtual_memory().used provides total RAM used by processes</span>
            <span class="n">current_global_memory_bytes</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">virtual_memory</span><span class="p">()</span><span class="o">.</span><span class="n">used</span>
            <span class="n">current_global_memory_mb</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">current_global_memory_bytes</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ScalingMemCheck] Current global memory usage (used): </span><span class="si">{</span><span class="n">current_global_memory_mb</span><span class="si">}</span><span class="s2"> MB&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">current_global_memory_mb</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;[ScalingMemCheck] Failed to get current system memory usage: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Attempting to use previous value (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">prev_global_memory_usage</span><span class="si">}</span><span class="s2"> MB).&quot;</span><span class="p">,</span>
                <span class="n">exc_info</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Use previous value if available, otherwise default to 0 (less ideal, but avoids None)</span>
            <span class="c1"># Returning 0 might incorrectly signal low memory usage if it&#39;s the first read that fails.</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_global_memory_usage</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_global_memory_usage</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate_scaling_adjustments</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">current_stage_metrics</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">global_in_flight</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">current_global_memory_mb</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Runs controllers to get target replica counts using topology for edge count.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        current_stage_metrics : Dict[str, Dict[str, Any]]</span>
<span class="sd">            The current stage metrics.</span>
<span class="sd">        global_in_flight : int</span>
<span class="sd">            The global in-flight count.</span>
<span class="sd">        current_global_memory_mb : int</span>
<span class="sd">            The current global memory usage in MB.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Dict[str, int]</span>
<span class="sd">            A dictionary of target replica counts for the stages.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;[ScalingCalc] Calculating adjustments via PID and RCM...&quot;</span><span class="p">)</span>
        <span class="c1"># Get edge count from topology</span>
        <span class="n">num_edges</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">get_edge_queues</span><span class="p">())</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">initial_proposals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pid_controller</span><span class="o">.</span><span class="n">calculate_initial_proposals</span><span class="p">(</span><span class="n">current_stage_metrics</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;[ScalingCalc] PID Initial Proposals:&quot;</span>
                <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="w"> </span><span class="p">{</span><span class="n">n</span><span class="p">:</span><span class="w"> </span><span class="n">p</span><span class="o">.</span><span class="n">proposed_replicas</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">initial_proposals</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span><span class="w"> </span><span class="si">}</span><span class="s2">&quot;</span>  <span class="c1"># noqa E201,E202</span>
            <span class="p">)</span>

            <span class="n">final_adjustments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraint_manager</span><span class="o">.</span><span class="n">apply_constraints</span><span class="p">(</span>
                <span class="n">initial_proposals</span><span class="o">=</span><span class="n">initial_proposals</span><span class="p">,</span>
                <span class="n">global_in_flight</span><span class="o">=</span><span class="n">global_in_flight</span><span class="p">,</span>
                <span class="n">current_global_memory_usage_mb</span><span class="o">=</span><span class="n">current_global_memory_mb</span><span class="p">,</span>
                <span class="n">num_edges</span><span class="o">=</span><span class="n">num_edges</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ScalingCalc] RCM Final Adjustments: </span><span class="si">{</span><span class="n">final_adjustments</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">final_adjustments</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ScalingCalc] Error during controller execution: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;[ScalingCalc] Falling back to current replica counts.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;replicas&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">metrics</span> <span class="ow">in</span> <span class="n">current_stage_metrics</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_apply_scaling_actions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">final_adjustments</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Applies scaling by calling _scale_stage, using topology for validation.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        final_adjustments : Dict[str, int]</span>
<span class="sd">            A dictionary of target replica counts for the stages.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">stages_needing_action</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">current_actors_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">get_stage_actors</span><span class="p">()</span>  <span class="c1"># Snapshot</span>

        <span class="k">for</span> <span class="n">stage_name</span><span class="p">,</span> <span class="n">target_replica_count</span> <span class="ow">in</span> <span class="n">final_adjustments</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">current_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">current_actors_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">stage_name</span><span class="p">,</span> <span class="p">[]))</span>
            <span class="n">stage_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">get_stage_info</span><span class="p">(</span><span class="n">stage_name</span><span class="p">)</span>  <span class="c1"># Get info from topology</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">stage_info</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ScalingApply] Cannot apply scaling for unknown stage &#39;</span><span class="si">{</span><span class="n">stage_name</span><span class="si">}</span><span class="s2">&#39;. Skipping.&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># Clamp target using StageInfo from topology</span>
            <span class="n">clamped_target</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">stage_info</span><span class="o">.</span><span class="n">min_replicas</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">stage_info</span><span class="o">.</span><span class="n">max_replicas</span><span class="p">,</span> <span class="n">target_replica_count</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">clamped_target</span> <span class="o">!=</span> <span class="n">target_replica_count</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;[ScalingApply-</span><span class="si">{</span><span class="n">stage_name</span><span class="si">}</span><span class="s2">] Target </span><span class="si">{</span><span class="n">target_replica_count</span><span class="si">}</span><span class="s2"> clamped to </span><span class="si">{</span><span class="n">clamped_target</span><span class="si">}</span><span class="s2"> by bounds.&quot;</span>
                <span class="p">)</span>
                <span class="n">target_replica_count</span> <span class="o">=</span> <span class="n">clamped_target</span>

            <span class="k">if</span> <span class="n">target_replica_count</span> <span class="o">!=</span> <span class="n">current_count</span><span class="p">:</span>
                <span class="n">stages_needing_action</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">stage_name</span><span class="p">,</span> <span class="n">target_replica_count</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;[ScalingApply-</span><span class="si">{</span><span class="n">stage_name</span><span class="si">}</span><span class="s2">] Action: Current=</span><span class="si">{</span><span class="n">current_count</span><span class="si">}</span><span class="s2">, &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Target=</span><span class="si">{</span><span class="n">target_replica_count</span><span class="si">}</span><span class="s2"> (Min=</span><span class="si">{</span><span class="n">stage_info</span><span class="o">.</span><span class="n">min_replicas</span><span class="si">}</span><span class="s2">, Max=</span><span class="si">{</span><span class="n">stage_info</span><span class="o">.</span><span class="n">max_replicas</span><span class="si">}</span><span class="s2">)&quot;</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">stages_needing_action</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;[ScalingApply] No scaling actions required.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">max_workers</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stages_needing_action</span><span class="p">),</span> <span class="mi">8</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;[ScalingApply] Submitting </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">stages_needing_action</span><span class="p">)</span><span class="si">}</span><span class="s2"> scaling actions (</span><span class="si">{</span><span class="n">max_workers</span><span class="si">}</span><span class="s2"> workers)...&quot;</span>
        <span class="p">)</span>
        <span class="n">action_results</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">with</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">ThreadPoolExecutor</span><span class="p">(</span>
            <span class="n">max_workers</span><span class="o">=</span><span class="n">max_workers</span><span class="p">,</span> <span class="n">thread_name_prefix</span><span class="o">=</span><span class="s2">&quot;ScalingAction&quot;</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
            <span class="n">future_to_stage</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_scale_stage</span><span class="p">,</span> <span class="n">stage_name</span><span class="p">,</span> <span class="n">target_count</span><span class="p">):</span> <span class="n">stage_name</span>
                <span class="k">for</span> <span class="n">stage_name</span><span class="p">,</span> <span class="n">target_count</span> <span class="ow">in</span> <span class="n">stages_needing_action</span>
            <span class="p">}</span>
            <span class="n">wait_timeout</span> <span class="o">=</span> <span class="mf">180.0</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ScalingApply] Waiting up to </span><span class="si">{</span><span class="n">wait_timeout</span><span class="si">}</span><span class="s2">s for actions...&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">as_completed</span><span class="p">(</span><span class="n">future_to_stage</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">wait_timeout</span><span class="p">):</span>
                <span class="n">stage_name</span> <span class="o">=</span> <span class="n">future_to_stage</span><span class="p">[</span><span class="n">future</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>  <span class="c1"># Raises exception if _scale_stage failed internally</span>
                    <span class="n">action_results</span><span class="p">[</span><span class="n">stage_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;completed&quot;</span><span class="p">,</span> <span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="n">result</span><span class="p">}</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ScalingApply-</span><span class="si">{</span><span class="n">stage_name</span><span class="si">}</span><span class="s2">] Action completed.&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">TimeoutError</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ScalingApply-</span><span class="si">{</span><span class="n">stage_name</span><span class="si">}</span><span class="s2">] Action timed out (</span><span class="si">{</span><span class="n">wait_timeout</span><span class="si">}</span><span class="s2">s).&quot;</span><span class="p">)</span>
                    <span class="n">action_results</span><span class="p">[</span><span class="n">stage_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;timeout&quot;</span><span class="p">}</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">update_scaling_state</span><span class="p">(</span><span class="n">stage_name</span><span class="p">,</span> <span class="s2">&quot;Error&quot;</span><span class="p">)</span>  <span class="c1"># Mark as error on timeout</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ScalingApply-</span><span class="si">{</span><span class="n">stage_name</span><span class="si">}</span><span class="s2">] Action failed: </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">action_results</span><span class="p">[</span><span class="n">stage_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;exception&quot;</span><span class="p">:</span> <span class="n">exc</span><span class="p">}</span>
                    <span class="c1"># State should be set to Error inside _scale_stage or its handlers on failure</span>

        <span class="n">completed</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">action_results</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;completed&quot;</span><span class="p">)</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">action_results</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;error&quot;</span><span class="p">)</span>
        <span class="n">timeouts</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">action_results</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;timeout&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ScalingApply] Summary: </span><span class="si">{</span><span class="n">completed</span><span class="si">}</span><span class="s2"> completed, </span><span class="si">{</span><span class="n">errors</span><span class="si">}</span><span class="s2"> errors, </span><span class="si">{</span><span class="n">timeouts</span><span class="si">}</span><span class="s2"> timeouts.&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_perform_scaling_and_maintenance</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Orchestrates scaling/maintenance using topology and stats collector.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stopping</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Pipeline is stopping. Skipping scaling cycle.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamic_memory_scaling</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Dynamic memory scaling disabled. Skipping cycle.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">get_is_flushing</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Skipping scaling cycle: Queue flush in progress (topology state).&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">got_lock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">got_lock</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Could not acquire lock for maintenance; skipping cycle.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">cycle_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stopping</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Pipeline began stopping after acquiring lock. Skipping maintenance logic.&quot;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;--- Performing Scaling &amp; Maintenance Cycle ---&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_pipeline_quiet</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_consecutive_quiet_cycles</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pipeline is quiet. Consecutive quiet cycles: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_consecutive_quiet_cycles</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_consecutive_quiet_cycles</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">consecutive_quiet_cycles_for_flush</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Pipeline has been quiet for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_consecutive_quiet_cycles</span><span class="si">}</span><span class="s2"> cycles. &quot;</span>
                        <span class="s2">&quot;Initiating queue flush.&quot;</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_queue_flush</span><span class="p">():</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_last_queue_flush_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_consecutive_quiet_cycles</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Reset after attempting flush</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Pipeline is quiet, but waiting for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">consecutive_quiet_cycles_for_flush</span><span class="si">}</span><span class="s2"> &quot;</span>
                        <span class="s2">&quot;consecutive quiet cycles before flushing.&quot;</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_consecutive_quiet_cycles</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Pipeline is no longer quiet. Resetting consecutive quiet cycle count &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;from </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_consecutive_quiet_cycles</span><span class="si">}</span><span class="s2"> to 0.&quot;</span>
                    <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_consecutive_quiet_cycles</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Queue flush interval reached, but pipeline is not quiet. Deferring.&quot;</span><span class="p">)</span>

            <span class="c1"># Fast return check if stopping occurred while flushing or checking flush status</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stopping</span><span class="p">:</span>
                <span class="k">return</span>

            <span class="n">current_stage_stats</span><span class="p">,</span> <span class="n">global_in_flight</span><span class="p">,</span> <span class="n">last_update_time</span><span class="p">,</span> <span class="n">stats_were_successful</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stats_collector</span><span class="o">.</span><span class="n">get_latest_stats</span><span class="p">()</span>
            <span class="p">)</span>

            <span class="n">last_update_age</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">last_update_time</span>
            <span class="n">max_age</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">15.0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stats_collection_interval_seconds</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">current_stage_stats</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">stats_were_successful</span> <span class="ow">or</span> <span class="n">last_update_age</span> <span class="o">&gt;</span> <span class="n">max_age</span><span class="p">:</span>
                <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;No stats&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">current_stage_stats</span> <span class="k">else</span> <span class="s2">&quot;Failed&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">stats_were_successful</span> <span class="k">else</span> <span class="s2">&quot;Stale&quot;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;[Scaling] Cannot scale reliably: Stats </span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2"> (Age: </span><span class="si">{</span><span class="n">last_update_age</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">s). Skipping cycle.&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span>

            <span class="n">current_stage_metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gather_controller_metrics</span><span class="p">(</span><span class="n">current_stage_stats</span><span class="p">,</span> <span class="n">global_in_flight</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">current_stage_metrics</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;[Scaling] Failed to gather metrics. Skipping.&quot;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="n">current_global_memory_mb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_current_global_memory</span><span class="p">()</span>
            <span class="n">final_adjustments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_scaling_adjustments</span><span class="p">(</span>
                <span class="n">current_stage_metrics</span><span class="p">,</span> <span class="n">global_in_flight</span><span class="p">,</span> <span class="n">current_global_memory_mb</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prev_global_memory_usage</span> <span class="o">=</span> <span class="n">current_global_memory_mb</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_apply_scaling_actions</span><span class="p">(</span><span class="n">final_adjustments</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;--- Scaling &amp; Maintenance Cycle Complete (Duration: </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">cycle_start_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s) ---&quot;</span>
            <span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  <span class="c1"># noqa</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Exception during maintenance cycle&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_state_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

    <span class="c1"># --- Lifecycle Methods for Monitoring/Scaling Threads ---</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_scaling_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">interval</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Main loop for the scaling thread.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        interval : float</span>
<span class="sd">            The interval in seconds.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Scaling loop started. Interval: </span><span class="si">{</span><span class="n">interval</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scaling_monitoring</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_perform_scaling_and_maintenance</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in scaling loop: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">sleep_time</span> <span class="o">=</span> <span class="n">interval</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scaling_monitoring</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">sleep_time</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Scaling loop finished.&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_start_scaling</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">poll_interval</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">10.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Starts the scaling thread.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        poll_interval : float, optional</span>
<span class="sd">            The interval in seconds, by default 10.0.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scaling_monitoring</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_scaling_monitoring</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_scaling_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_scaling_loop</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">poll_interval</span><span class="p">,),</span> <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_scaling_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Scaling/Maintenance thread launched (Interval: </span><span class="si">{</span><span class="n">poll_interval</span><span class="si">}</span><span class="s2">s).&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_stop_scaling</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stops the scaling thread.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scaling_monitoring</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Stopping scaling/maintenance thread...&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_scaling_monitoring</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scaling_thread</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_scaling_thread</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>  <span class="c1"># Allow more time for scaling actions</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scaling_thread</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Scaling thread did not exit cleanly.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_scaling_thread</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Scaling/Maintenance stopped.&quot;</span><span class="p">)</span>

    <span class="c1"># --- Pipeline Start/Stop ---</span>
<div class="viewcode-block" id="RayPipeline.start">
<a class="viewcode-back" href="../../../../../../nv-ingest/nv_ingest.framework.orchestration.ray.primitives.html#nv_ingest.framework.orchestration.ray.primitives.ray_pipeline.RayPipeline.start">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">monitor_poll_interval</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span> <span class="n">scaling_poll_interval</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">30.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Starts the pipeline actors and background monitoring threads.</span>

<span class="sd">        Assumes the pipeline has already been built via the `build()` method.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        monitor_poll_interval : float, optional</span>
<span class="sd">            This parameter is currently unused but is kept for interface compatibility.</span>
<span class="sd">        scaling_poll_interval : float, optional</span>
<span class="sd">            The interval in seconds for the autoscaling and maintenance thread to run, by default 30.0.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">get_all_actors</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Cannot start: Pipeline not built or has no actors.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting pipeline execution...&quot;</span><span class="p">)</span>

        <span class="c1"># Start all actors</span>
        <span class="n">actors_to_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">get_all_actors</span><span class="p">()</span>
        <span class="n">start_futures</span> <span class="o">=</span> <span class="p">[</span><span class="n">actor</span><span class="o">.</span><span class="n">start</span><span class="o">.</span><span class="n">remote</span><span class="p">()</span> <span class="k">for</span> <span class="n">actor</span> <span class="ow">in</span> <span class="n">actors_to_start</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">start_futures</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Waiting for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">start_futures</span><span class="p">)</span><span class="si">}</span><span class="s2"> actors to start...&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ray</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">start_futures</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">60.0</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">start_futures</span><span class="p">)</span><span class="si">}</span><span class="s2"> actors started.&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error/Timeout starting actors: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>  <span class="c1"># Attempt cleanup</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Pipeline start failed: actors did not start.&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

        <span class="c1"># Start background threads</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">start_cleanup_thread</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats_collector</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_scaling</span><span class="p">(</span><span class="n">poll_interval</span><span class="o">=</span><span class="n">scaling_poll_interval</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Pipeline started successfully.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="RayPipeline.stop">
<a class="viewcode-back" href="../../../../../../nv-ingest/nv_ingest.framework.orchestration.ray.primitives.html#nv_ingest.framework.orchestration.ray.primitives.ray_pipeline.RayPipeline.stop">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stops the pipeline and all associated actors and threads.</span>

<span class="sd">        This method performs a graceful shutdown by:</span>
<span class="sd">        1.  Stopping the autoscaling and statistics collection threads.</span>
<span class="sd">        2.  Signaling all actors to stop and waiting for confirmation.</span>
<span class="sd">        3.  Stopping the topology cleanup thread.</span>
<span class="sd">        4.  Clearing all runtime state from the topology.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Stopping pipeline...&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stopping</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Stop already in progress.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stopping</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># 1. Stop background threads first to prevent new actions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_scaling</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats_collector</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

        <span class="c1"># 2. Stop all actors and wait for them</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Stopping all actors in the topology...&quot;</span><span class="p">)</span>
        <span class="n">all_actors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">get_all_actors</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">all_actors</span><span class="p">:</span>
            <span class="n">stop_futures</span> <span class="o">=</span> <span class="p">[</span><span class="n">actor</span><span class="o">.</span><span class="n">stop</span><span class="o">.</span><span class="n">remote</span><span class="p">()</span> <span class="k">for</span> <span class="n">actor</span> <span class="ow">in</span> <span class="n">all_actors</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ready</span><span class="p">,</span> <span class="n">not_ready</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">stop_futures</span><span class="p">,</span> <span class="n">num_returns</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">stop_futures</span><span class="p">),</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">60.0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">not_ready</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Timeout waiting for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">not_ready</span><span class="p">)</span><span class="si">}</span><span class="s2"> actors to stop. &quot;</span> <span class="sa">f</span><span class="s2">&quot;Proceeding with shutdown.&quot;</span>
                    <span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ready</span><span class="p">)</span><span class="si">}</span><span class="s2"> actors confirmed stop.&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;An unexpected error occurred during actor shutdown: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># 3. Stop the topology cleanup thread now that actors are stopped</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">stop_cleanup_thread</span><span class="p">()</span>

        <span class="c1"># 4. Clear all state and references</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Clearing pipeline topology runtime state.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">clear_runtime_state</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_stopping</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Pipeline stopped successfully.&quot;</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;RayPipeline&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Enter the runtime context related to this object.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        RayPipeline</span>
<span class="sd">            The pipeline instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Exit the runtime context related to this object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span></div>

</pre></div>

                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            

<div class="bd-sidebar-secondary"></div>


              
            

          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  

  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../../../../../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../../../../../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>


  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">
<a class="footer-brand logo" href="https://www.nvidia.com">
  <img src="../../../../../../_static/nvidia-logo-horiz-rgb-1c-blk-for-screen.svg" class="logo__image only-light" alt="NVIDIA"/>
  <img src="../../../../../../_static/nvidia-logo-horiz-rgb-1c-wht-for-screen.svg" class="logo__image only-dark" alt="NVIDIA"/>
</a></div>
      
        <div class="footer-item">

<div class="footer-links">
  
  
  
  
  
</div>
</div>
      
        <div class="footer-item">




  <p class="copyright">
    
      Copyright  2025, Nvidia.
      <br/>
    
  </p>
</div>
      
    </div>
  
  
  
</div>

  </footer>
  </body>
</html>