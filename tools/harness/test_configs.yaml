# nv-ingest Test Configuration
# Edit the 'active' section directly to configure your test runs

# Active configuration (used by default when running tests)
active:
  # Dataset configuration
  dataset_dir: /path/to/dataset
  test_name: null  # Auto-generated if null

  # API configuration
  api_version: v2 # v1 or v2
  pdf_split_page_count: null # V2 only: pages per chunk (null = default 32)

  # Infrastructure
  hostname: localhost
  readiness_timeout: 600

  # Docker Compose configuration
  compose:
    profiles:
      - retrieval
      - reranker  # Required for recall evaluation

  # Helm configuration
  helm:
    bin: microk8s helm  # Helm binary command (e.g., "helm", "microk8s helm", "k3s helm")
    sudo: true  # Prepend sudo to helm commands (needed for microk8s/k3s without user in group)
    kubectl_bin: microk8s kubectl  # kubectl binary command (e.g., "kubectl", "microk8s kubectl")
    kubectl_sudo: null  # Prepend sudo to kubectl commands (null = same as helm_sudo)
    chart: nemo-microservices/nv-ingest  # Remote chart reference (set to null to use local chart from ./helm)
    chart_version: 26.1.2  # Chart version (required for remote charts)
    release: nv-ingest
    namespace: nv-ingest
    values_file: .helm-env  # Optional: path to values file
    # Multiple port forwards for Helm services
    port_forwards:
      - service: nv-ingest
        local_port: 7670
        remote_port: 7670
      - service: nv-ingest-milvus
        local_port: 19530
        remote_port: 19530
      - service: nv-ingest-milvus
        local_port: 9091
        remote_port: 9091
      - service: nv-ingest-minio
        local_port: 9000
        remote_port: 9000
      - service: "*embed*"  # Wildcard pattern to match embedding services
        local_port: 8012
        remote_port: 8000
      - service: "*rerank*"  # Wildcard pattern to match reranker services
        local_port: 8020
        remote_port: 8000
    values:  # inline Helm values
      nimOperator.llama_3_2_nv_rerankqa_1b_v2.enabled: true

  # Runtime configuration
  sparse: false  # Use sparse embeddings (Milvus only)
  gpu_search: false  # Use GPU for search
  embedding_model: auto  # auto-detect or specify model name
  vdb_backend: milvus  # milvus or lancedb
  hybrid: false  # LanceDB hybrid retrieval (FTS + vector)

  # Extraction configuration
  extract_text: true
  extract_tables: true
  extract_charts: true
  extract_images: false
  extract_infographics: true
  text_depth: page
  # table_output_format: markdown

  # Optional pipeline steps
  enable_caption: false  # Enable image captioning (ensure vlm profile is enabled)
  caption_prompt: null  # Override caption user prompt (null = service default)
  caption_reasoning: null  # Enable reasoning: true = enable, false = disable, null = service default (default is false)

  enable_split: false  # Enable text chunking
  split_chunk_size: 1024  # Chunk size for text splitting
  split_chunk_overlap: 150  # Overlap for text splitting
  enable_image_storage: false  # Enable server-side image storage (defaults to MinIO; set IMAGE_STORAGE_URI=file://... to opt into disk)

  # Storage configuration
  spill_dir: /tmp/spill
  artifacts_dir: null  # null = use default (tools/harness/artifacts)
  collection_name: null  # null = auto-generated

  # Custom UDF Configs - add specific udf configs here if needed.
  llm_summarization_model: nvdev/nvidia/llama-3.1-nemotron-70b-instruct  # LLM for summarization - this does NOT propagate to the UDF, but useful for artifact storage.

# Recall configuration (only used when running recall or e2e_recall tests)
# Remember to start the reranker service before running recall tests:
# docker compose --profile reranker up -d
recall:
  recall_dataset: null
  reranker_mode: none  # Options: "none", "with", "both"

  # Recall evaluation settings
  recall_top_k: 10
  ground_truth_dir: null
  enable_beir: false  # Enable BEIR metrics (NDCG, MAP, Precision) - requires beir package
  language_filter: null  # Filter queries by language (e.g., "english") - Vidore only

# Pre-configured datasets
# Each dataset includes path, extraction settings, and recall evaluator
# Use: uv run nv-ingest-harness-run --case=e2e --dataset=bo767
datasets:
  bo767:
    path: /path/to/bo767
    extract_text: true
    extract_tables: true
    extract_charts: true
    extract_images: false
    extract_infographics: false
    recall_dataset: bo767

  earnings:
    path: /path/to/earnings_consulting
    extract_text: true
    extract_tables: true
    extract_charts: true
    extract_images: false
    extract_infographics: false
    recall_dataset: earnings

  bo20:
    path: /path/to/bo20
    extract_text: true
    extract_tables: true
    extract_charts: true
    extract_images: true
    extract_infographics: true
    recall_dataset: null

  financebench:
    path: /path/to/financebench
    extract_text: true
    extract_tables: true
    extract_charts: true
    extract_images: true
    extract_infographics: true
    recall_dataset: finance_bench

  # Single file example
  single:
    path: data/multimodal_test.pdf
    extract_text: true
    extract_tables: true
    extract_charts: true
    extract_images: true
    extract_infographics: true
    recall_dataset: null  # No recall evaluator for single file

# Example of a custom dataset configuration
  jensen_single:
    path: /path/to/jensen.pdf
    extract_text: true
    extract_tables: true
    extract_charts: true
    extract_images: true
    extract_infographics: true
    recall_dataset: null  # No recall evaluator for single file

  bo10k:
    path: /path/to/bo10k
    extract_text: true
    extract_tables: true
    extract_charts: true
    extract_images: false
    extract_infographics: true
    recall_dataset: bo10k

  jp20:
    path: /path/to/jp20
    extract_text: true
    extract_tables: true
    extract_charts: true
    extract_images: false
    extract_infographics: true
    recall_dataset: jp20

  # Vidore V3 Benchmark Datasets
  # See: https://huggingface.co/collections/vidore/vidore-benchmark-667173f98e70a1c0fa4db00d
  vidore_v3_finance_en:
    path: /datasets/nv-ingest/vidore_v3_corpus_pdf/vidore_v3_finance_en
    extract_text: true
    extract_tables: true
    extract_charts: true
    extract_images: false
    extract_infographics: true
    extract_page_as_image: true
    text_depth: page
    table_output_format: markdown
    image_elements_modality: text_image
    recall_dataset: vidore_v3_finance_en
    enable_beir: true

  vidore_v3_industrial:
    path: /datasets/nv-ingest/vidore_v3_corpus_pdf/vidore_v3_industrial
    extract_text: true
    extract_tables: true
    extract_charts: true
    extract_images: false
    extract_infographics: true
    extract_page_as_image: true
    text_depth: page
    table_output_format: markdown
    image_elements_modality: text_image
    recall_dataset: vidore_v3_industrial
    enable_beir: true

  vidore_v3_computer_science:
    path: /datasets/nv-ingest/vidore_v3_corpus_pdf/vidore_v3_computer_science
    extract_text: true
    extract_tables: true
    extract_charts: true
    extract_images: false
    extract_infographics: true
    extract_page_as_image: true
    text_depth: page
    table_output_format: markdown
    image_elements_modality: text_image
    recall_dataset: vidore_v3_computer_science
    enable_beir: true

  vidore_v3_pharmaceuticals:
    path: /datasets/nv-ingest/vidore_v3_corpus_pdf/vidore_v3_pharmaceuticals
    extract_text: true
    extract_tables: true
    extract_charts: true
    extract_images: false
    extract_infographics: true
    extract_page_as_image: true
    text_depth: page
    table_output_format: markdown
    image_elements_modality: text_image
    recall_dataset: vidore_v3_pharmaceuticals
    enable_beir: true

  vidore_v3_hr:
    path: /datasets/nv-ingest/vidore_v3_corpus_pdf/vidore_v3_hr
    extract_text: true
    extract_tables: true
    extract_charts: true
    extract_images: false
    extract_infographics: true
    extract_page_as_image: true
    text_depth: page
    table_output_format: markdown
    image_elements_modality: text_image
    recall_dataset: vidore_v3_hr
    enable_beir: true

  vidore_v3_energy:
    path: /datasets/nv-ingest/vidore_v3_corpus_pdf/vidore_v3_energy
    extract_text: true
    extract_tables: true
    extract_charts: true
    extract_images: false
    extract_infographics: true
    extract_page_as_image: true
    text_depth: page
    table_output_format: markdown
    image_elements_modality: text_image
    recall_dataset: vidore_v3_energy
    enable_beir: true

  vidore_v3_physics:
    path: /datasets/nv-ingest/vidore_v3_corpus_pdf/vidore_v3_physics
    extract_text: true
    extract_tables: true
    extract_charts: true
    extract_images: false
    extract_infographics: true
    extract_page_as_image: true
    text_depth: page
    table_output_format: markdown
    image_elements_modality: text_image
    recall_dataset: vidore_v3_physics
    enable_beir: true

  vidore_v3_finance_fr:
    path: /datasets/nv-ingest/vidore_v3_corpus_pdf/vidore_v3_finance_fr
    extract_text: true
    extract_tables: true
    extract_charts: true
    extract_images: false
    extract_infographics: true
    extract_page_as_image: true
    text_depth: page
    table_output_format: markdown
    image_elements_modality: text_image
    recall_dataset: vidore_v3_finance_fr
    enable_beir: true

# Dataset groups for running multiple datasets together
# Use: uv run nv-ingest-harness-run --case=e2e_recall --dataset=vidore
dataset_groups:
  # All Vidore V3 datasets
  vidore:
    - vidore_v3_finance_en
    - vidore_v3_industrial
    - vidore_v3_computer_science
    - vidore_v3_pharmaceuticals
    - vidore_v3_hr
    - vidore_v3_energy
    - vidore_v3_physics
    - vidore_v3_finance_fr

  # Vidore English-only (set language_filter: english in recall section)
  vidore_english:
    - vidore_v3_finance_en
    - vidore_v3_industrial
    - vidore_v3_computer_science
    - vidore_v3_pharmaceuticals
    - vidore_v3_hr

  # Vidore quick test (smallest datasets)
  vidore_quick:
    # - vidore_v3_hr
    # - vidore_v3_industrial
    - vidore_v3_computer_science
