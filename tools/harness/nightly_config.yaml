# Copyright (c) 2025, NVIDIA CORPORATION.
# SPDX-License-Identifier: Apache-2.0
#
# Nightly Benchmark Configuration
#
# This file defines what runs in the nightly benchmark and how results are reported.
# Extraction settings (text, tables, charts, etc.) come from test_configs.yaml datasets section.
#
# Usage:
#   uv run nv-ingest-harness-nightly
#   uv run nv-ingest-harness-nightly --config custom_nightly.yaml

# Benchmark runs
runs:
  # E2E tests (ingestion only, no recall)
  e2e:
    - bo20  # Latency benchmark (20 docs, 496 pages)

  # E2E + Recall tests (ingestion + recall evaluation)
  e2e_recall:
    - bo767        # Throughput + recall (767 docs)
    - earnings     # Earnings consulting dataset
    - financebench # Financebench full dataset
    # - bo10k        # Large scale benchmark (10k docs)

# Recall configuration (applies to all e2e_recall runs)
recall:
  reranker_mode: both  # Options: "none", "with", "both"
  reranker_endpoint: http://localhost:8020/v1/ranking  # Local container
  top_k: 10

# Sinks configuration
sinks:
  slack:
    enabled: true
    # webhook_url: Set via SLACK_WEBHOOK_URL environment variable

  history:
    enabled: true
    # db_path: Set via HARNESS_HISTORY_DB environment variable
    retention_days: 90  # Auto-prune runs older than 90 days

# Infrastructure
infrastructure:
  readiness_timeout: 600  # Seconds to wait for services to be ready
  hostname: localhost  # Hostname for service endpoints

  # Docker Compose configuration
  compose:
    profiles:  # Docker compose profiles to start
      - retrieval
      - table-structure
      - reranker  # Required for recall evaluation

  # Helm configuration
  helm:
    bin: microk8s helm  # Helm binary command (e.g., "helm", "microk8s helm", "k3s helm")
    sudo: true  # Prepend sudo to helm commands (needed for microk8s/k3s without user in group)
    kubectl_bin: microk8s kubectl  # kubectl binary command (e.g., "kubectl", "microk8s kubectl")
    kubectl_sudo: null  # Prepend sudo to kubectl commands (null = same as helm_sudo)
    chart: nim-nvstaging/nv-ingest  # Remote chart reference (set to null to use local chart from ./helm)
    chart_version: 26.1.0-RC7  # Chart version (required for remote charts)
    release: nv-ingest
    namespace: nv-ingest
    values_file: .helm-env  # Optional: path to values file
    # Multiple port forwards for Helm services
    port_forwards:
      - service: nv-ingest
        local_port: 7670
        remote_port: 7670
      - service: nv-ingest-milvus
        local_port: 19530
        remote_port: 19530
      - service: nv-ingest-milvus
        local_port: 9091
        remote_port: 9091
      - service: "*embed*"  # Wildcard pattern to match embedding services
        local_port: 8012
        remote_port: 8000
    # values:  # Optional: inline Helm values
    #   api.enabled: true
    #   redis.enabled: true
